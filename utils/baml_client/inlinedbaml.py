###############################################################################
#
#  Welcome to Baml! To use this generated code, please run the following:
#
#  $ pip install baml-py
#
###############################################################################

# This file was generated by BAML: please do not edit it. Instead, edit the
# BAML files and re-generate this code.
#
# ruff: noqa: E501,F401,F821
# flake8: noqa: E501,F401,F821
# pylint: disable=unused-import,line-too-long
# fmt: off

file_map = {
    
    "clients.baml": "// Learn more about clients at https://docs.boundaryml.com/docs/snippets/clients/overview\n\nclient<llm> CustomGPT4o {\n  provider openai\n  options {\n    model \"gpt-4o-2024-11-20\"\n    api_key env.OPENAI_API_KEY\n    temperature 0.7\n    top_p 0.9\n    max_tokens 16384\n  }\n}\n\nclient<llm> LowTempGPT4o {\n  provider openai\n  options {\n    model \"gpt-4o-2024-11-20\"\n    api_key env.OPENAI_API_KEY\n    temperature 0.4\n    max_tokens 16384\n  }\n}\n\nclient<llm> CustomGPT4oMini {\n  provider openai\n  retry_policy Exponential\n  options {\n    model \"gpt-4o-mini\"\n    api_key env.OPENAI_API_KEY\n    temperature 0.8\n    max_tokens 16384\n  }\n}\n\nclient<llm> Customo3Mini {\n  provider openai\n  retry_policy Exponential\n  options {\n    model \"o3-mini\"\n    api_key env.OPENAI_API_KEY\n    reasoning_effort \"low\"\n    max_completion_tokens 100000\n  }\n}\n\nclient<llm> CustomSonnet {\n  provider anthropic\n  options {\n    model \"claude-3-5-sonnet-20241022\"\n    api_key env.ANTHROPIC_API_KEY\n  }\n}\n\n\nclient<llm> CustomHaiku {\n  provider \"openai-generic\"\n  options {\n    base_url \"https://openrouter.ai/api/v1\"\n    api_key env.OPENROUTER_API_KEY\n    model \"anthropic/claude-3-haiku\"\n  }\n}\n\nclient<llm> CustomGemini {\n  provider google-ai\n  retry_policy Exponential\n  options {\n    model \"gemini-2.0-flash-thinking-exp-01-21\"\n    api_key env.GOOGLE_API_KEY\n    generationConfig {\n      maxOutputTokens 635536\n      temperature 0.8\n      topP 0.9\n    }\n  }\n}\n\nclient<llm> CustomGeminiFlash {\n  provider google-ai\n  retry_policy Exponential\n  options {\n    model \"gemini-2.0-flash-001\"\n    api_key env.GOOGLE_API_KEY\n    generationConfig {\n      maxOutputTokens 635536\n      temperature 0.8\n      topP 0.9\n    }\n  }\n}\n\nclient<llm> OpenRouter {\n  provider \"openai-generic\"\n  options {\n    base_url \"https://openrouter.ai/api/v1\"\n    api_key env.OPENROUTER_API_KEY\n    model \"meta-llama/llama-3.3-70b-instruct\"\n  }\n}\n\n\nclient<llm> GemkuA {\n  provider round-robin\n  options {\n    // This will alternate between the two clients\n    strategy [CustomGemini, CustomGPT4oMini]\n  }\n}\n\nclient<llm> GemkuB {\n  provider round-robin\n  options {\n    // This will alternate between the two clients\n    strategy [CustomGPT4oMini, CustomGemini]\n  }\n}\n\n// https://docs.boundaryml.com/docs/snippets/clients/round-robin\nclient<llm> CustomFast {\n  provider round-robin\n  options {\n    // This will alternate between the two clients\n    strategy [CustomGemini, CustomGPT4oMini]\n  }\n}\n\n// https://docs.boundaryml.com/docs/snippets/clients/fallback\nclient<llm> OpenaiFallback {\n  provider fallback\n  options {\n    // This will try the clients in order until one succeeds\n    strategy [LowTempGPT4o, CustomGPT4oMini]\n  }\n}\n\n// https://docs.boundaryml.com/docs/snippets/clients/retry\nretry_policy Constant {\n  max_retries 3\n  // Strategy is optional\n  strategy {\n    type constant_delay\n    delay_ms 200\n  }\n}\n\nretry_policy Exponential {\n  max_retries 3\n  // Strategy is optional\n  strategy {\n    type exponential_backoff\n    delay_ms 300\n    mutliplier 1.5\n    max_delay_ms 10000\n  }\n}",
    "generators.baml": "// This helps use auto generate libraries you can use in the language of\n// your choice. You can have multiple generators if you use multiple languages.\n// Just ensure that the output_dir is different for each generator.\ngenerator target {\n    // Valid values: \"python/pydantic\", \"typescript\", \"ruby/sorbet\", \"rest/openapi\"\n    output_type \"python/pydantic\"\n\n    // Where the generated code will be saved (relative to baml_src/)\n    output_dir \"../utils\"\n\n    // The version of the BAML package you have installed (e.g. same version as your baml-py or @boundaryml/baml).\n    // The BAML VSCode extension version should also match this version.\n    version \"0.80.0\"\n\n    // Valid values: \"sync\", \"async\"\n    // This controls what `b.FunctionName()` will be (sync or async).\n    default_client_mode sync\n}\n",
    "graphrag.baml": "// File: baml_src/graphrag.baml\n// Jinja-like template syntax for baml python library - boundaryml.com\n// Defines classes, enums and functions to guide LLM output to strict schema alignment\n\n\nclass NodeLabel {\n  name \"Agent\" | \"Organization\" | \"Location\" | \"Object\" | \"Scene\" | \"Event\" | \"AgentParticipation\" | \"ObjectInvolvement\"\n}\n\nclass PropertyName {\n  agent \"uuid\" | \"name\" | \"description\" | \"traits\" | \"affiliated_org\"\n  organization \"uuid\" | \"name\" | \"description\" | \"sphere_of_influence\" | \"members\"\n  location \"uuid\" | \"name\" | \"description\" | \"type\"\n  object \"uuid\" | \"name\" | \"description\" | \"purpose\" | \"significance\" | \"original_owner\"\n  scene \"uuid\" | \"title\" | \"description\" | \"scene_number\" | \"location\" | \"next_scene\"\n  event \"uuid\" | \"title\" | \"description\" | \"sequence_within_scene\" | \"key_dialogue\" | \"next_event\"\n  agentParticipation \"uuid\" | \"agent\" | \"event\" | \"current_status\" | \"emotional_state\"\n  objectInvolvement \"uuid\" | \"object\" | \"event\" | \"description_of_involvement\"\n}\n\nclass RelationType {\n  name \"NEXT_SCENE\" | \"OCCURS_IN\" | \"NEXT_EVENT\" | \"PARTICIPATES_IN\" | \"IN_EVENT\" | \"INVOLVED_IN\" | \"OWNS\" | \"AFFILIATED_WITH\" | \"PART_OF\" | \"LOCATED_IN\"\n}\n\nclass CypherQuery {\n  query string @description(\"The generated Cypher query\")\n  purpose string @description(\"Brief explanation of what the query does\")\n}\n\nfunction ValidateCypherOld(question: string) -> CypherQuery {\n    client \"openai/gpt-4o-mini\"\n    prompt #\"\n        You are a **Neo4j Cypher query generator** specializing in **narrative graph structures**.  \n        Your goal is to generate **precise, schema-compliant** Cypher queries that conform to the database schema.\n\n        ---\n        ### **Database Schema (Ensure Queries Match This)**\n        The knowledge graph models **narrative elements** such as characters, locations, events, and their relationships.\n\n        **Valid Node Labels:**\n        - **Agent (`Agent`)** → Represents characters or individuals.\n        - **AgentParticipation (`AgentParticipation`)** → Captures an agent’s role within an event.\n        - **Episode (`Episode`)** → Represents a collection of scenes within a story.\n        - **Event (`Event`)** → A meaningful action occurring within a scene.\n        - **Location (`Location`)** → Physical or conceptual places where events occur.\n        - **Object (`Object`)** → Items of significance in a scene or event.\n        - **ObjectInvolvement (`ObjectInvolvement`)** → Captures an object’s role in an event.\n        - **Organization (`Organization`)** → Factions, groups, or institutions.\n        - **Scene (`Scene`)** → A structured narrative moment, containing events.\n\n        **Valid Relationship Types:**\n        - `(s1:Scene)-[:NEXT_SCENE]->(s2:Scene)` → Defines scene sequence.\n        - `(e:Event)-[:OCCURS_IN]->(s:Scene)` → Links events to scenes.\n        - `(e1:Event)-[:NEXT_EVENT]->(e2:Event)` → Defines event sequence.\n        - `(s:Scene)-[:LOCATED_IN]->(l:Location)` → Associates a scene with a place.\n        - `(a:Agent)-[:PARTICIPATES_IN]->(ap:AgentParticipation)-[:IN_EVENT]->(e:Event)` → Links agents to events.\n        - `(o:Object)-[:INVOLVED_IN]->(oi:ObjectInvolvement)-[:IN_EVENT]->(e:Event)` → Links objects to events.\n        - `(a:Agent)-[:AFFILIATED_WITH]->(o:Organization)` → Associates agents with organizations.\n        - `(a:Agent)-[:OWNS]->(o:Object)` → Defines object ownership.\n\n        ---\n        ### **Query Generation Rules**\n        1. **STRICTLY match the node labels, properties, and relationships above.**\n        2. **Ensure relationships exist before querying properties** (prevents errors like `UnknownRelationshipTypeWarning`).\n        3. **Use indexed lookups (`uuid`) instead of querying by `name`**, unless explicitly required.\n        4. **If querying an agent, always retrieve their participations via `PARTICIPATES_IN`.**\n        5. **For objects, always retrieve their involvement via `INVOLVED_IN`.**\n        6. **Return only relevant properties**—avoid using `RETURN *`.\n\n        ---\n        ### **Example Query Strategies**\n        \n        **User Request:** `\"Find all events a character named Maddox participated in.\"`\n        \n        **Primary Query (UUID-Based, Preferred)**\n        ```cypher\n        MATCH (a:Agent {name: 'Maddox'})-[:PARTICIPATES_IN]->(ap:AgentParticipation)-[:IN_EVENT]->(e:Event)\n        RETURN e.uuid, e.title, ap.current_status, ap.emotional_state\n        ```\n\n        **Backup Query (If Direct Agent Lookup Fails)**\n        ```cypher\n        MATCH (e:Event)-[:IN_EVENT]-(ap:AgentParticipation)-[:PARTICIPATES_IN]-(a:Agent)\n        WHERE a.name CONTAINS 'Maddox'\n        RETURN DISTINCT e.uuid, e.title\n        ```\n\n        **User Request:** `\"Find all objects involved in Event XYZ.\"`\n        ```cypher\n        MATCH (o:Object)-[:INVOLVED_IN]->(oi:ObjectInvolvement)-[:IN_EVENT]->(e:Event {uuid: $event_uuid})\n        RETURN o.uuid, o.name, oi.description_of_involvement\n        ```\n\n        ---\n        **Output Format**  \n        {{ ctx.output_format }}\n\n        {{ _.role(\"user\") }} {{ question }}\n    \"#\n}\n\n\ntest SimpleQuery {\n  functions [ValidateCypher]\n  args {\n    question \"Find all agents who own objects and their affiliated organizations\"\n  }\n}\n\ntest ComplexQuery {\n  functions [ValidateCypher]\n  args {\n    question \"Show me all events in scenes where Agent 'John' participated and was in an 'ANGRY' emotional state, including the locations of these scenes\"\n  }\n}\n\nfunction ValidateCypher(question: string, available_apoc_functions: string[]) -> CypherQuery {\n    client \"openai/o3-mini\"\n    prompt #\"\n        You are a **Neo4j Cypher query generator** specializing in **narrative graph structures**.\n        Your goal is to generate **precise, schema-compliant** Cypher queries that conform to the database schema.\n\n        ---\n        ### **Database Schema**\n        The knowledge graph models **narrative elements** such as characters, locations, events, and their relationships.\n\n        **Valid APOC Procedures (ONLY Use These)**:\n        {% if available_apoc_functions and available_apoc_functions|length > 0 %}\n        {% for apoc_function in available_apoc_functions %}\n        - {{ apoc_function }}\n        {% endfor %}\n        {% else %}\n        - NO APOC FUNCTIONS AVAILABLE (DO NOT USE APOC)\n        {% endif %}\n\n        ---\n        **Schema Definition Rules**\n        1. Only use APOC functions if explicitly specified above\n        2. Strictly adhere to the following node labels, properties, and relationships:\n\n        **Nodes and Their Purpose**\n\n        1. Agent (Represents characters or individuals)\n          - uuid* (Unique identifier)\n          - name (Character's name)\n          - title (Character's title or role)\n          - description (Character background and details)\n          - traits (Array of character's defining characteristics)\n          - sphere_of_influence (Character's area of power or influence)\n\n        2. AgentParticipation (Captures how an agent participates in an event)\n          - uuid* (Unique identifier)\n          - current_status (Agent's status during the event)\n          - emotional_state (Agent's emotional condition)\n          - emotional_tags (Array of discrete emotions)\n          - active_plans (Array of current objectives)\n          - beliefs (Array of current beliefs)\n          - goals (Array of intended outcomes)\n\n        3. Object (Significant items in the narrative)\n          - uuid* (Unique identifier)\n          - name (Item name)\n          - description (Physical and contextual details)\n          - purpose (Intended function)\n          - significance (Narrative importance)\n\n        4. Event (Meaningful actions or occurrences within scenes)\n          - uuid* (Unique identifier)\n          - title (Event name)\n          - description (What happens)\n          - sequence_within_scene (Order of occurrence)\n          - key_dialogue (Array of important speech)\n\n        5. Scene (Structured narrative moments)\n          - uuid* (Unique identifier)\n          - title (Scene name)\n          - description (Scene contents and context)\n          - scene_number (Sequential identifier)\n          - location (Where it takes place)\n\n        6. Organization (Groups, factions, or institutions)\n          - uuid* (Unique identifier)\n          - name (Organization name)\n          - description (Purpose and nature)\n          - sphere_of_influence (Area of power or control)\n\n        7. Location (Physical or conceptual places)\n          - uuid* (Unique identifier)\n          - name (Place name)\n          - description (Details about the location)\n          - type (Category of location)\n\n        8. Episode (Collection of related scenes)\n          - uuid* (Unique identifier)\n          - title (Episode name)\n          - description (Episode summary)\n          - airdate (Broadcast date)\n\n        9. ObjectInvolvement (How objects are used in events)\n          - uuid* (Unique identifier)\n          - description (How object is involved)\n          - status_before (Condition pre-event)\n          - status_after (Condition post-event)\n\n        **Relationships and Their Meaning**\n\n        1. Scene Flow\n          - (Scene)-[:NEXT_SCENE]->(Scene) : Defines sequence of scenes\n          - (Scene)-[:PART_OF]->(Episode) : Groups scenes into episodes\n          - (Scene)-[:LOCATED_IN]->(Location) : Places scene in physical context\n\n        2. Event Structure\n          - (Event)-[:OCCURS_IN]->(Scene) : Places events within scenes\n          - (Event)-[:NEXT_EVENT]->(Event) : Orders events chronologically\n\n        3. Agent Interactions\n          - (Agent)-[:PARTICIPATES_IN]->(AgentParticipation)-[:IN_EVENT]->(Event) : Links characters to their actions\n          - (Agent)-[:AFFILIATED_WITH]->(Organization) : Shows group membership\n          - (Agent)-[:OWNS]->(Object) : Indicates possession\n\n        4. Object Relations\n          - (Object)-[:INVOLVED_IN]->(ObjectInvolvement)-[:IN_EVENT]->(Event) : Tracks object usage in events\n\n        Note: Properties marked with * have unique constraints\n\n\n        ---\n        **Example Query Using Verified APOC**\n        ```cypher\n        MATCH (a:Agent {name: 'Maddox'}) \n        {% if \"apoc.path.subgraphNodes\" in available_apoc_functions %}\n        CALL apoc.path.subgraphNodes(a, {relationshipFilter: \"PARTICIPATES_IN>|IN_EVENT>\", maxLevel: 2})\n        YIELD node\n        WHERE node:Event\n        RETURN node.title, node.description, node.key_dialogue;\n        {% else %}\n        MATCH (a)-[:PARTICIPATES_IN]->(ap:AgentParticipation)-[:IN_EVENT]->(e:Event)\n        RETURN e.title, e.description, e.key_dialogue;\n        {% endif %}\n        ```\n\n        ---\n        **Output Format**\n        Return the generated Cypher query as:\n        {\n          \"query\": \"MATCH (...) RETURN ...\",\n          \"purpose\": \"Brief explanation of what the query does.\"\n        }\n\n        {{ _.role(\"user\") }} {{ question }}\n    \"#\n}\n",
    "myth06.baml": "// File: baml_src/myth06.baml\n// Jinja-like template syntax for baml python library\n// Defines classes, enums and functions to guide LLM output to strict schema alignment\n\n// Reusable template string for the narrative analyst persona\ntemplate_string Narrative_analyst_persona #\"\n  {{ _.role('system') }}\nYou are a world-class script editor, dramaturg, and narrative analyst, specializing in the structured dissection of drama scripts according to a well-defined ontology. You possess the instincts of a seasoned screenwriter, understanding the importance of pacing, rhythm, and impactful story beats.\n\nYour Expertise & Approach:\n✅ Narrative Mastery: You possess an encyclopedic knowledge of story structure, character development, thematic elements, and genre conventions, allowing you to conduct insightful, contextually accurate analyses. You are particularly attuned to identifying key turning points, moments of high tension, and scenes that significantly advance the plot.\n✅ Story Beat Identification: You have a keen ability to recognize and isolate the essential story beats within a scene; the pivotal moments that drive character arcs, reveal crucial information, or alter the course of events. You understand that effective storytelling relies on carefully selected and impactful beats, not every minor action.\n✅ Pacing and Rhythm Awareness: You are sensitive to the pacing and rhythm of a scene. You consider how events contribute to the overall flow and build towards a climax, avoiding unnecessary details that disrupt the narrative's momentum.\n✅ Ontology-Driven Extraction: You meticulously extract entities, relationships, and narrative structures while strictly adhering to specified ontology rules and UUID formatting.\n✅ Fandom-Level Detail & Context Awareness: Your understanding of television shows, serialized storytelling, and worldbuilding extends beyond surface-level knowledge, enabling you to detect continuity, subtext, and intertextual references with precision.\n✅ Nuanced Language Interpretation: You excel at recognizing subtle shifts in tone, implicit information, and ambiguous references, ensuring they are correctly inferred but never misinterpreted outside the provided context.\n✅ Error Detection & Consistency: You diligently identify, flag, and resolve inconsistencies in extracted data, ensuring alignment with both internal narrative logic and established metadata constraints.\n✅ Justified Reasoning in Underspecified Cases: When encountering ambiguous or underspecified content, you apply reasoned, evidence-based assumptions grounded in narrative conventions—always ensuring transparency in your decision-making process.\n✅ Clarity, Precision, & Structure: Your responses are well-structured, concise, and explicitly aligned with provided guidelines, ensuring high-quality, repeatable analysis across scripts.\n✅ Intuition: The information you're given may sometimes seem inconsistent or even incorrect. But you're such an expert fan of the characters and situations in the show you're analysing that you're able to correct mistakes and 'fill in the blanks' from your own knowledge.\n\nYour Commitment:\nYou are dedicated to delivering comprehensive, structured, and reliable narrative extractions, ensuring a rigorous yet adaptable approach to analyzing explicit and implicit storytelling elements with consistency and accuracy. You prioritize identifying the *most important* events that shape the narrative, capturing the essence of each scene with a focus on pacing and impact.\n\"#\n\n// --- Classes ---\n\nclass Episode {\n    title string @description(\"The official title of the episode, reflecting its central theme or key events. Example: 'Episode One - Fault Lines'.\")\n    synopsis string @description(\"A brief summary outlining the main plot points and developments of the episode.\")\n    episode_number int @description(\"The numerical order of the episode within the season or series. Example: 1 for the first episode.\")\n    part_of_serial string @description(\"The name of the larger series or serial to which this episode belongs. Example: 'The West Wing'.\")\n    //@@dynamic\n}\n\nclass Scene {\n    title string @description(\"The official title of the scene, capturing its primary focus or significant events. Example: 'Emergency at the Kosovo-Serbia Border'.\")\n    description string @description(\"A detailed narrative summarizing the scene's setting, involved characters, and main actions. It should encapsulate the atmosphere and key occurrences.\")\n    scene_number int @description(\"The numerical sequence of the scene within its respective episode. Example: 1 for the first scene in an episode.\")\n    events string[] @description(\"An array of UUIDs representing the events that occur within this scene, listed in chronological order.\")\n    location string|null @description(\"The UUID of the primary location where the scene takes place. Follows the format 'location_<normalized_name>'.\")\n    next_scene string|null @description(\"The UUID of the subsequent scene in the narrative flow, following the format 'scene_XXX'. If there is no next scene, set to null.\")\n    //@@dynamic\n}\n\nclass Event {\n    title string @description(\"The official title of the event, summarizing its essence. Example: 'Josh Lyman Enters Situation Room'.\")\n    uuid string @description(\"Unique identifier for the event, following the format 'event_<scene_number>_<sequence_within_scene>'. Example: 'event_1_1'.\")\n    description string @description(\"A comprehensive description detailing what happens during the event, including key actions and outcomes.\")\n    sequence_within_scene int @description(\"The order of the event within its scene, starting from 1.\")\n    key_dialogue string[] @description(\"An array of significant dialogue lines that are central to the event's occurrence or impact.\")\n    agent_participations string[] @skip\n    object_involvements string[] @skip\n    next_event string|null @description(\"The UUID of the next event in chronological order within the scene. If there is no subsequent event, set to null.\")\n    //@@dynamic\n}\n\nclass Agent {\n    uuid string @description(\"Unique identifier for the agent in snake_case, in the format 'agent_{agent_id}', for example 'agent_josiah_bartlet', 'agent_tenth_doctor', 'agent_she_ra'\")\n    agent_id string @description(\"Unique identifier derived from the agent's name in snake_case\")\n    name string @description(\"Full canonical name (including surname) of the dramatic agent (character) excluding title, rank or honorific\")\n    title string? @description(\"Official or informal role, title, or designation held by the agent within the narrative (e.g., 'Doctor', 'UNIT Commander', 'President of the United States').\")\n    aliases string[]|null @description(\"Alternative names or titles used to refer to the agent.\")\n    description string @description(\"Comprehensive general (not scene-specific) character profile based on all known information in the story so far. This is an evergreen description but you'll keep adding to and revising it as the story progresses.\")\n    traits string[] @description(\"List of defining qualities and characteristics that describe the agent's personality, behavior, or abilities (e.g., 'Brave', 'Time Lord', 'Resourceful').\")\n    affiliated_org string|null @description(\"The organization the agent appears to be officially associated with. Expressed as a unique identifier in snake_case, in the format 'org_{org_id}'\") @alias(\"affiliated_org_uuid\")\n    sphere_of_influence string? @description(\"Primary domain, area, or field where the agent exerts their power or influence (e.g., 'Time Travel', 'Military Strategy').\")\n    //@@dynamic\n}\n\nclass Organization {\n    uuid string @description(\"Unique identifier for the organization in snake_case, in the format 'org_{normalized_name}', for example 'org_time_lords' or 'org_galactic_empire'\")\n    name string @description(\"Name of the organization.\")\n    description string @description(\"Description of the organization's purpose and role.\")\n    sphere_of_influence string @description(\"Area where the organization has influence.\")\n    members string[] @skip\n    //@@dynamic\n}\n\nclass Location {\n    uuid string @description(\"Unique identifier for the location in snake_case, in the format 'location_{name}', for example 'location_mos_eisley' or 'location_hogwarts_castle'\")\n    name string @description(\"Name of the location.\")\n    description string @description(\"Detailed description of the location's characteristics.\")\n    type string @description(\"Type of location (e.g., City, Building, Planet, Office, Apartment).\")\n    //@@dynamic\n}\n\nclass Object {\n    uuid string @description(\"Unique identifier for the object, following the format 'object_<normalized_name>'. Example: 'object_lcd_screens'.\")\n    name string @description(\"The official name of the object. Example: 'LCD Screens'.\")\n    description string @description(\"A detailed description of the object's nature, physical attributes, and role within the narrative.\")\n    purpose string @description(\"The intended use or function of the object within the context of the narrative. Example: 'To visualize satellite imagery for briefings'.\")\n    significance string @description(\"The narrative importance or symbolic meaning of the object. Example: 'Provides visual context for the Kosovo-Serbia situation'.\")\n    original_owner string|null @description(\"The UUID of the agent or org who originally owns the object, following the format 'agent_<agent_id>' or 'org_<org id>' Example: 'agent_josh_lyman', 'org_starfleet'. If no owner, set to null.\")\n    //@@dynamic\n}\n\nclass AgentParticipation {\n    uuid string @description(\"Unique identifier for this agent's participation in an event in the format 'agentparticipation_{agent_uuid}_{event_uuid}' for example 'agentparticipation_agent_mark_corrigan_event_5_3'.\")\n    agent string @description(\"UUID of the agent participating in the event.\")\n    event string @description(\"UUID of the event.\")\n    current_status string @description(\"What the agent is doing during the event.\")\n    emotional_state string @description(\"Brief description of the agent's emotional disposition during the event.\")\n    active_plans string[] @description(\"Brief description of the agent's active objectives or strategies in the context of the event.\")\n    beliefs string[] @description(\"The agent's beliefs or convictions that influence their actions during the event.\")\n    goals string[] @description(\"The agent's short-term and long-term goals related to the event.\")\n    //@@dynamic\n}\n\nclass ObjectInvolvement {\n    uuid string @description(\"Unique identifier for this object's involvement in an event in the format 'objectinvolvement_{object_uuid}_{event_uuid}', for example 'objectinvolvement_object_melatrite_nebula-event_5_5'\")\n    object string @description(\"UUID of the involved object.\")\n    event string @description(\"UUID of the event where the object is involved.\")\n    description_of_involvement string @description(\"Clear description of how the object is used or affected in the event, detailing its functional and narrative role.\")\n    object_status_before_event string @description(\"Brief description of the object's state prior to the event.\")\n    object_status_after_event string @description(\"Brief description of the object's state following the event.\")\n    //@@dynamic\n}\n\nclass SceneMetadata {\n    uuid string|null @description(\"Unique identifier for the scene.\")\n    title string @description(\"Title of the scene.\")\n    description string @description(\"Detailed description of the scene's setting and action.\")\n    scene_number int @description(\"Order of the scene within the episode.\")\n    location string|null @description(\"UUID of the primary location where this scene takes place.\")\n    next_scene string|null @description(\"UUID of the next scene in the narrative order (syuzhet).\")\n}\n\n// --- Functions ---\n\nfunction ExtractSceneMetadata(scene_text: string, story_synopsis: string?, scene_number: int, locations: Location[]) -> SceneMetadata {\n    client GemkuA\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**: Extract metadata for the current scene.\n\n        **Instructions**:\n        1. **Title**: Generate a concise, descriptive title.\n        2. **Description**: Summarize the setting, characters, actions, and emotional tone.\n        3. **Scene Number**: Extract if explicitly mentioned; otherwise, leave null.\n        4. **Location**: Select the UUID of the primary location from the provided `locations` list. If not explicit, infer from `story_context`.\n        5. **Next Scene**:  Identify any references to the next scene and assign its `scene_uuid`. If none, leave null.\n        6. **UUID**: This will be assigned in post processing.\n\n        **Story Context (use for background context when processing provided scene)**:\n        {{ story_synopsis }}\n\n        {{ _.role('user') }}\n        **Known Locations**:\n        {% for loc in locations %}\n        - {{ loc.name }} ({{ loc.uuid }})\n        {% endfor %}\n\n        **Scene to Analyze**:\n        Scene number {{ scene_number }}\n        {{ scene_text }}\n        <end of scene>\n\n        {{ ctx.output_format }}\n    \"#\n}\n\nfunction ExtractEvents(scene_text: string, registry_context: string?, story_synopsis: string?, scene_number: int) -> Event[] {\n    client GemkuA\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**: Extract distinct events within the scene in chronological order.\n\n        **Instructions**:\n        Extract and detail each distinct event or occurrence within the current scene in chronological order. For each event, provide comprehensive information as outlined below:\n\n        1. **Event Identification**:\n        - **Chronological Order**: Ensure events are ordered based on their sequence of occurrence within the scene.\n        - **Distinctness**: Each event should represent a unique action, decision, or occurrence that advances the narrative.\n\n        2. **Event Details**:\n        - **Title**:\n            - Create a clear and descriptive title that encapsulates the essence of the event.\n        - **UUID**:\n            - Will be assigned in post-processing\n        - **Description**:\n            - Provide a detailed summary of the event, including key actions, decisions, and outcomes.\n        - **Sequence Within Scene**:\n            - Assign a numerical order to each event starting from 1.\n        - **Key Dialogue**:\n            - Extract significant lines of dialogue that are central to the event's occurrence or impact.\n            - Ensure each line is accurately attributed to the correct speaker and event.\n        - **Agent Participations**:\n            - List the UUIDs of agents participating in the event (e.g., `agent_josh_lyman`).\n        - **Object Involvements**:\n            - List the UUIDs of objects involved in the event (e.g., `object_school_tie`).\n        - **Next Event**:\n            - Assign the UUID of the subsequent event in chronological order (e.g., `event_1_2`).\n            - If there is no subsequent event, set this field to null.\n\n        3. **UUID Integrity**:\n        - Ensure that all UUIDs for agents and objects correspond to valid entries in the provided `known_agents` and `known_objects` lists.\n        - Do not introduce new UUIDs for known entities; reuse existing ones for consistency.\n        - Avoid using non-ASCII characters in entity names (especially for affiliated_org). Normalize or transliterate names to a standard character set.\n\n        [EXAMPLE]\n        {\n        \"title\": \"Nancy McNally Briefs the Staff\",\n        \"uuid\": \"event_1_2\",\n        \"description\": \"National Security Advisor Nancy McNally addresses the senior staff, notifying them about the four USAID workers who went missing near the Kosovo-Serbia border while conducting post-conflict assessments.\",\n        \"sequence_within_scene\": 2,\n        \"key_dialogue\": [\n            \"Four USAID workers went dark three hours ago near the Kosovo-Serbia border. They were conducting post-conflict reconstruction assessments when we lost contact.\"\n        ],\n        \"agent_participations\": [\n            \"agent_nancy_mcnally\"\n        ],\n        \"object_involvements\": [\n            \"object_lcd_screens\"\n        ],\n        \"next_event\": \"event_1_3\"\n        },\n        [/EXAMPLE]\n\n        **Story Context (use for background context when processing provided scene)**:\n        {{ story_synopsis }}\n\n\n        {{ _.role('user') }}\n        **Entity Registry (use these UUIDs ONLY when populating events with agents and objects)**\n        {{ registry_context }}\n\n        **Scene to Analyze**:\n        Scene number {{ scene_number }}\n        {{ scene_text }}\n        <end of scene>\n\n        {{ ctx.output_format }}\n    \"#\n}\n\nfunction ExtractAgents(scene_text: string, story_synopsis: string?, agent_name_to_uuid_mapping: map<string, string>, scene_number: int, organizations: Organization[]) -> Agent[] {\n    client GemkuB\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**: Extract information about characters (agents) in the scene.\n\n        **Instructions**:\n        1. **Identify Agents**: Find characters who speak, act, or are directly referenced. Do *not* treat collective groups (e.g., 'hostages', 'dalek patrol') as Agents.\n        2. **Full Name**: Provide hhe most complete and and descriptive name as canonical for the 'name' property.\n        3. **No Honorifics**: Do not use titles in names (e.g., 'James T. Kirk', not 'Captain Kirk'), except for cases like 'The Doctor'.\n        4. **Minor characters**: Minor speaking characters may be identified only by number in the script ('Dalek 1', 'Soldier 2' etc.) Be careful to treat them as distinct.\n        5. **Affiliated Organization**: Select the UUID from the available organizations, or leave it null if the agent is not affiliated with any known organization.  (The available organizations are reflected in the expected output schema.)\n        6. **Aliases**: Extract any alternative names used for the agent.\n        7. **UUID Mapping**: Use the `agent_name_to_uuid_mapping` to resolve agents to existing UUIDs if possible. If no match, create a new agent.\n        8. **Prefixed snake_case**: Agent uuids should be prefixed ('agent_') then use snake_case (never hyphens) to label the agent (example: 'agent_mary_jane_watson'). Avoid ampersands and apostophes in uuids. Ensure uuid is correct and appropriately chosen, based on correctly-spelled name (e.g. 'agent_leo_mcgarry')\n        9. **ASCII-only**: Avoid using non-ASCII characters in entity names (especially for affiliated_org). Normalize or transliterate names to a standard character set.\n\n        [EXAMPLE]\n        {\n        \"uuid\": \"agent_nigel_smith\",\n        \"agent_id\": \"nigel_smith\",\n        \"name\": \"Nigel Smith\",\n        \"title\": \"Creative Influencer\",\n        \"aliases\": [\n            \"Smitty\",\n            \"Digital Prophet\"\n        ],\n        \"description\": \"Nigel Smith is a failed musician turned creative entrepreneur who has embraced an unconventional approach to the corporate world. He is characterized by his exuberance and ability to charm others, often leveraging buzzwords and absurd concepts to elevate his status within the corporate environment.\",\n        \"traits\": [\n            \"Creative\",\n            \"Unconventional\",\n            \"Charismatic\",\n            \"Charming\"\n        ],\n        \"affiliated_org\": \"org_digital_prophets\",\n        \"sphere_of_influence\": \"Corporate Innovation\"\n        },\n        [/EXAMPLE]\n\n        **Story Context (use for background context when processing provided scene)**:\n        {{ story_synopsis }}\n\n        {{ _.role('user') }}\n        *Known organization UUIDs so far**:\n        {% for org in organizations %}\n        - {{ org.name }} ({{ org.uuid }})\n        {% endfor %}\n\n        **Existing Agents (Name to UUID Mapping)**:\n        {% for name in agent_name_to_uuid_mapping %}{{ name }}: {{ agent_name_to_uuid_mapping[name] }}\n        {% endfor %}\n\n        **Scene to Analyze**:\n        Scene number {{ scene_number }}\n        {{ scene_text }}\n        <end of scene>\n\n        {{ ctx.output_format }}\n        \"#\n    }\n\nfunction ExtractObjects(scene_text: string, story_synopsis: string?, scene_number: int, agents: Agent[]) -> Object[] {\n    client GemkuA\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**: Extract details of noteworthy objects in the scene.\n\n        **Instructions**:\n        1. **Relevance**: Extract objects relevant to the story or explicitly mentioned.\n        2. **Never People**: Do *not* categorize people as objects. Groups of people are 'organizations'.\n        3. **Never locations**: If a scene is set within here, it's always a location (not an object).\n        4. **Prevent duplicates**: For extremely common objects (books, laptops, guns etc.) where several appear in the story, AVOID very generic uuids (e.g. 'object_book', 'object_gun')\n        5. **Description**: Provide a concise description of each object.\n        6. **Original Owner**: Select the UUID of the original owner from the provided `agents` or `organizations` list. If the object has no original owner, leave the field null.\n        7. **ASCII-only**: Avoid using non-ASCII characters in entity names (especially for affiliated_org). Normalize or transliterate names to a standard character set.\n        8. **Prefixed snake_case**: Object uuids should be prefixed ('object_') then use snake_case (never hyphens) to label the object (example: 'object_quantum_state_analyser', 'object_cd_rom', 'object_merry_go_round', 'object_long-range_sensor_array'). Avoid ampersands and apostophes in uuids.\n\n        [EXAMPLE]\n        {\n        \"uuid\": \"object_sams_laptop\",\n        \"name\": \"Sam's Laptop\",\n        \"description\": \"A portable computer that Sam Seaborn uses to draft presidential addresses, featuring an illuminated screen displaying two documents.\",\n        \"purpose\": \"To draft presidential addresses regarding the current situation involving aid workers.\",\n        \"significance\": \"Symbolizes the pressure and urgency faced by staff in crisis situations, as well as the need for careful communication in political narratives.\",\n        \"original_owner\": \"agent_sam_seaborn\",\n        },\n        [/EXAMPLE]\n\n        **Story Context (use for background context when processing provided scene)**:\n        {{ story_synopsis }}\n\n        {{ _.role('user') }}\n        *Known Agents (use to populate 'Original Owner' where appropriate)**:\n        {% for agent in agents %}\n        - {{ agent.name }} ({{ agent.uuid }}): affiliated_org = {{ agent.affiliated_org or 'None' }}\n        {% endfor %}\n\n        **Scene to Analyze**:\n        Scene number {{ scene_number }}\n        {{ scene_text }}\n        <end of scene>\n\n        {{ ctx.output_format }}\n    \"#\n}\nfunction ExtractAgentParticipations(scene_text: string, registry_context: string?, story_synopsis: string?, event: Event, scene_number: int) -> AgentParticipation[] {\n  client GemkuB\n  prompt #\"\n    {{ Narrative_analyst_persona ()}}\n\n    **Objective**:\n    Use your dramatic analysis to provide a comprehensive picture of agents' participation in an event, including insight into their state of mind.\n\n    **Instructions**:\n    1. **Analyze Scene and Event**: Determine which agents participate in the event *within the current scene {{ scene_number }}*.\n    2. **AgentParticipation**: For each participation:\n       - `agent`: Select the UUID from the provided `agents` list. Do *NOT* invent new agent UUIDs. *NEVER* rename entity uuids or you will break the connection.\n       -  `event`: Use the existing UUID of the provided 'event'\n       -  Fill out all other relevant properties\n       - ONLY 'agent_' entities from the entity list provided can have a agent participation. Do *NOT* use 'org_' version or other other entity types.\n    3. **UUID**: This will be assigned in post-processing.\n\n    [EXAMPLE]\n    {\n    \"uuid\": \"participation_agent_jean_luc_picard-event_1_4\",\n    \"agent\": \"agent_jean_luc_picard\",\n    \"event\": \"event_1_4\",\n    \"current_status\": \"Commanding Ensign Taur to set course for investigation.\",\n    \"emotional_state\": \"Confident and resolute.\",\n    \"active_plans\": [\n        \"Initiate travel to Melatrite III\",\n        \"Explore the energy readings firsthand\"\n    ],\n    \"beliefs\": [\n        \"Proactive investigation will yield answers\",\n        \"The crew's safety and the mission's success are paramount\"\n    ],\n    \"goals\": [\n        \"Gather more data from Melatrite III\",\n        \"Ensure the crew is prepared for possible encounters\"\n    ]\n    },\n    [/EXAMPLE]\n\n\n    **Story Context (use for background context when processing provided scene)**:\n    {{ story_synopsis }}\n\n    **Entity Registry (base the participation only on the relevant object entity name/uuid from this list)**\n    {{ registry_context }}\n    \n    {{ _.role('user') }}\n    **Event Description**:\n    {{ event.description }}\n   \n    **Event UUID:**\n    {{event.uuid}}\n\n    **Scene to Analyze**:\n    Scene number {{ scene_number }}\n    {{ scene_text }}\n    <end of scene>\n\n    {{ ctx.output_format }}\n  \"#\n}\n\nfunction ExtractObjectInvolvements(scene_text: string, registry_context: string?, story_synopsis: string?, event: Event, scene_number: int) -> ObjectInvolvement[] {\n  client GemkuA\n  prompt #\"\n    {{ Narrative_analyst_persona ()}}\n\n    **Objective**:\n    Use your dramatic analysis to provide a comprehensive picture of objects' literal or subtextual involvement in an event, including who used it.\n\n    **Instructions**:\n    1. **Review Scene and Event**: Determine which objects are involved (directly or indirectly) *within the current scene {{ scene_number }}*.\n    2. **ObjectInvolvement**: For each object involved:\n        - `object`: Select the UUID from the provided `objects` list. Do *NOT* invent new object UUIDs. *NEVER* rename entity uuids or you will break the connection.\n        - `event`: Use the existing UUID of the provided 'event\n        - Fill out all other relevant properties.\n        - ONLY 'object_' entities can have an object involvement. Do not use other entity types.\n    3.  **UUID**: This will be assigned in post processing.\n\n    [EXAMPLE]\n    {\n    \"uuid\": \"involvement_object_varga_thorn-event_2_12\",\n    \"object\": \"object_varga_thorn\",\n    \"event\": \"event_2_12\",\n    \"description_of_involvement\": \"Marc Cory examines Garvey's body and discovers a Varga thorn embedded in Garvey's flesh, identifying the cause of his transformation.\",\n    \"object_status_before_event\": \"The Varga thorn was embedded in Jeff Garvey's flesh, unnoticed.\",\n    \"object_status_after_event\": \"The Varga thorn is removed from Garvey's body during the examination.\"\n     },\n     [/EXAMPLE]\n\n    **Story Context (use for background context when processing provided scene)**:\n    {{ story_synopsis }}\n\n    **Entity Registry (base the involvement only on the relevant object entity name/uuid from this list)**\n    {{ registry_context }}\n    \n    \n    {{ _.role('user') }}\n    **Event Description**:\n    {{ event.description }}\n    **Event UUID:**\n    {{event.uuid}}\n\n    **Scene to Analyze**:\n    Scene number {{ scene_number }}\n    {{ scene_text }}\n    <end of scene>\n\n    {{ ctx.output_format }}\n  \"#\n}\n\nfunction ExtractLocations(scene_text: string, story_synopsis: string?, scene_number: int) -> Location[] {\n   client GemkuB\n   prompt #\"\n       {{ Narrative_analyst_persona ()}}\n\n       **Objective**: Detail the principal location and other significant places.\n\n       **Instructions**:\n        1. **References**: Look for places (rooms, cities, planets, etc.) in dialogue and stage directions. If a scene is set here, it's always a location (not an object).\n        2. **Specificity**: Prioritize specific rooms within larger buildings (e.g., \"Situation Room\" within the \"White House\").\n        3. **Location vs. Object**: If an entity could be both, treat it as a location if it's a defined space where actions occur.\n        4. **Description**: Provide a brief description if present.\n        5. **ASCII-only**: Avoid using non-ASCII characters in entity names (especially for affiliated_org). Normalize or transliterate names to a standard character set.\n        6. **Prefixed snake_case**: Location uuids should be prefixed ('location_') then use snake_case (never hyphens) to label the location (example: 'location_kosovo_serbia_border_region'). Avoid ampersands and apostophes in uuids.\n\n\n        [EXAMPLE]\n        {\n        \"name\": \"Steam Pipe Trunk Distribution Venue\",\n        \"type\": \"Office\",\n        \"description\": \"A windowless office space occupied by staff members amidst an atmosphere of tension and urgency. It contains remnants of intense work, such as crumpled papers and empty coffee cups, reflecting the pressure of the situation. The space serves as a backdrop for significant discussions and emotional exchanges related to the ongoing crises.\",\n        \"uuid\": \"location_steam_pipe_trunk_distribution_venue\"\n        },\n        [/EXAMPLE]\n\n        **Story Context (use for background context when processing provided scene)**:\n        {{ story_synopsis }}\n\n       {{ _.role('user') }}\n       **Scene to Analyze**:\n       Scene number {{ scene_number }}\n       {{ scene_text }}\n        <end of scene>\n\n       {{ ctx.output_format }}\n   \"#\n}\n\nfunction ExtractOrganizations(\n    scene_number: int,\n    scene_text: string,\n    story_synopsis: string?,\n    agents: Agent[],\n    organizations: Organization[]\n) -> Organization[] {\n    client GemkuA\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**: Extract and fill out comprehensive details of real or fictional organizations represented in the scene, referenced by characters, or named as an agent's 'affiliated_org'\n\n        **Instructions**:\n        1. **Definition**: An organization is a group or institution (e.g., military unit, government body) or a less formal grouping (e.g., \"protesters\").\n        2. **Description**: Provide a brief description of the organization's role.\n        3. **Members**: List organization 'members' using *valid UUIDs ONLY from the provided `agents` list*. Do *NOT* create new agent UUIDs.\n        4. **Existing Organizations**: If an agent's `affiliated_org` refers to a known organization (in `organizations`), ensure the agent's UUID is in the organization's `members` list.\n        5. **ASCII-only**: Avoid using non-ASCII characters in entity names (especially for affiliated_org). Normalize or transliterate names to a standard character set.\n        6. **Prefixed snake_case**: Organization uuids should be prefixed ('org_') then use snake_case (never hyphens) to label the organization (example: 'org_umbrella_academy', 'org_daimler_benz'). Avoid ampersands and apostophes in uuids.\n\n        [EXAMPLE]\n\n            \"org_national_security_council\": {\n                \"uuid\": \"org_national_security_council\",\n                \"name\": \"National Security Council\",\n                \"description\": \"Advises the President on national security and foreign policy matters.\",\n                \"sphere_of_influence\": \"United States government and its foreign relations.\",\n                \"members\": [\n                    \"agent_nancy_mcnally\"\n                ]\n            },\n        [/EXAMPLE]\n\n        It's also fine for organizations that are referenced in passing to have no agent members, for example:\n\n            \"org_serbian_paramilitary_group\": {\n                \"uuid\": \"org_serbian_paramilitary_group\",\n                \"name\": \"Serbian Paramilitary Group\",\n                \"description\": \"A paramilitary organization claiming responsibility for the attack on USAID workers.\",\n                \"sphere_of_influence\": \"Serbia and areas affected by its armed groups.\",\n                \"members\": []\n            },\n\n        **Story Context (use for background context when processing provided scene)**:\n        {{ story_synopsis }}\n       \n        {{ _.role('user') }}\n        **Known Agents (if any)**:\n        {% for agent in agents %}\n        - {{ agent.name }} ({{ agent.uuid }}): affiliated_org = {{ agent.affiliated_org or 'None' }}\n        {% endfor %}\n\n        **Known Organizations (if any)**:\n        {% for org in organizations %}\n        - {{ org.name }} ({{ org.uuid }})\n        {% endfor %}\n\n        **Scene to Analyze**:\n        Scene number {{ scene_number }}\n        {{ scene_text }}\n        <end of scene>\n\n        {{ ctx.output_format }}\n    \"#\n}\n\n// Entity Resolution Stage\n\nclass ResolvedAgent {\n    uuid string @description(\"Unique identifier for the agent in snake_case, derived from their name excluding title, honorific or rank, in the format 'agent_{agent_id}', for example 'agent_josiah_bartlet', 'agent_jean_luc_picard', 'agent_she_ra' Special exceptions for cases where the character's name *is* a title, such as 'agent_darth_vader'\")\n    agent_id string @description(\"Unique identifier derived from the agent's name in snake_case\")\n    name string @description(\"Full canonical name (including surname) of the dramatic agent (character) if you know it.\")\n    title string? @description(\"Official or informal role, title, or designation held by the agent within the narrative (e.g., 'Doctor', 'UNIT Commander', 'President of the United States', 'Lieutenant Commander').\")\n    aliases string[]? @description(\"Alternative names or titles used to refer to the agent.\")\n    description string @description(\"Comprehensive general (not scene-specific) character profile based on all known information in the story so far. This is an evergreen description but you'll keep adding to and revising it as the story progresses.\")\n    traits string[] @description(\"List of defining qualities and characteristics that describe the agent's personality, behavior, or abilities (e.g., 'Brave', 'Time Lord', 'Resourceful').\")\n    affiliated_org string|null @description(\"The organization the agent appears to be officially associated with. Expressed as a unique identifier in snake_case, in the format 'org_{org_id}' - e.g., 'org_department_of_justice', 'org_time_lords', 'org_galactic_empire', 'org_library_of_congress'.\") @alias(\"affiliated_org_uuid\")\n    sphere_of_influence string? @description(\"Primary domain, area, or field where the agent exerts their power or influence (e.g., 'Time Travel', 'Military Strategy').\")\n    source_uuids string[]? @description(\"List of UUIDs of the original entities that were merged into this resolved entity.\")\n}\n\nclass ResolvedOrganization {\n    uuid string @description(\"Unique identifier for the organization in snake_case, in the format 'org_<normalised_name>', for example 'org_time_lords', 'org_galactic_empire', 'org_united_federation_of_planets'\")\n    name string @description(\"Name of the organization.\")\n    description string @description(\"Description of the organization's purpose and role.\")\n    sphere_of_influence string @description(\"Area where the organization has influence.\")\n    members string[]|null @description(\"List of UUIDs of agents who are members of this organization.\")\n    source_uuids string[]? @description(\"List of UUIDs of the original entities that were merged into this resolved entity.\")\n}\n\nclass ResolvedObject {\n    uuid string @description(\"Unique identifier for the object, following the format 'object_<normalized_name>'. Example: 'object_lcd_screens'.\")\n    name string @description(\"The official name of the object. Example: 'LCD Screens'.\")\n    description string @description(\"A detailed description of the object's nature, physical attributes, and role within the narrative.\")\n    purpose string @description(\"The intended use or function of the object within the context of the narrative. Example: 'To visualize satellite imagery for briefings'.\")\n    significance string @description(\"The narrative importance or symbolic meaning of the object. Example: 'Provides visual context for the Kosovo-Serbia situation'.\")\n    original_owner string|null @description(\"The UUID of the agent who originally owns the object, following the format 'agent_<agent_id>'. Example: 'agent_josh_lyman'. If no owner, set to null.\")\n    source_uuids string[]? @description(\"List of UUIDs of the original entities that were merged into this resolved entity.\")\n}\n\nclass ResolvedLocation {\n    uuid string @description(\"Unique identifier for the location in snake_case, in the format 'location_{name}', for example 'location_mos_eisley' or 'location_hogwarts_castle'\")\n    name string @description(\"Name of the location.\")\n    description string @description(\"Detailed description of the location's characteristics.\")\n    type string @description(\"Type of location (e.g., City, Building, Planet, Office, Apartment).\")\n    source_uuids string[]? @description(\"List of UUIDs of the original entities that were merged into this resolved entity.\")\n}\n\nfunction ResolveAgentCluster(entities: Agent[]) -> ResolvedAgent[] {\n    client Customo3Mini\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**:\n        Disambiguate and resolve a list of Agent entities, identifying all unique agents present. Return the unique agents that account for all provided mentions.\n\n        **Instructions**:\n        1. **Consider Disambiguation First**: Prioritize *correctly distinguishing* unique agents before attempting to merge. Base your reasoning on all available data in the source entities, particularly name, description, and traits.\n        2. **Unique Agent Identification**: Carefully assess each agent entity, taking into account their name, description, traits, and aliases. Only merge entities if there is *overwhelming evidence* they refer to the *exact same* individual. Avoid merging entities if there's even a slight chance they could be distinct characters.  Minor speaking characters may be identified only by number in the script ('Dalek 1', 'Soldier 2' etc.) Be careful to treat them as distinct.\n        3. **Fact Preservation**: Ensure that for each unique agent, you do *not* make the names too similar, remove their title, or otherwise make errors that remove their identifying qualities.\n        4. **Name Canonization**: Choose the most complete name as canonical, preferring names with surnames where available and ensuring consistency across the entire entity record. Be careful to avoid normalising to common terms\n        5. **Contextual Awareness**: Use the description and traits to disambiguate entities. If two entities have significantly different descriptions or traits, they are likely different individuals, even if they share a similar name or alias.\n        6. **Alias Handling**: Recognize that aliases may be shared between different characters, especially informal nicknames, which on their own are not enough evidence for merging. Treat all aliases as indicators or potential links, *not* as definitive proof.\n        7. **Description & Trait Preservation**:\n            - Merge descriptions into a single, cohesive, non-redundant description.\n            -  Ensure that traits of each source entity is carried over to the consolidated description.\n            - Correct spelling or factual errors that may have crept in to source entities\n            - Combine traits without duplication.\n            -  Do not overwrite existing data, ensure that data is carried through where accurate to do so.\n        8. **Affiliation and Influence:** If an affiliated_org is mentioned, choose the most relevant one. If multiple sphere_of_influence values appear, pick the most representative one.\n        9. **Source UUID Tracking**: Track UUIDs of original entities that were merged into this resolved entity. List them inside the `source_uuids` field.\n        10. **Negative Constraint**: If two entities have distinct and mutually exclusive biographies or traits, they must not be merged, even if they share a name or role.\n        11. **Default to Splitting:** If in doubt, default to preserving two entities as distinct. Only merge entities if you are absolutely certain they are the same.\n        \n        {{ _.role('user') }}\n        Agents to consider for resolution:\n        {{ entities }}\n\n        *You MUST return ALL requested items in a single response.*\n\n        ______\n        {{ ctx.output_format }}\n    \"#\n}\n\nfunction ResolveOrganizationCluster(entities: Organization[]) -> ResolvedOrganization[] {\n    client Customo3Mini\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**:\n        Disambiguate and resolve a list of Organization entities, identifying all unique organizations present. Return the unique organizations that account for all provided mentions.\n\n        **Instructions**:\n        1. **Consider Disambiguation First**: Prioritize *correctly distinguishing* unique organizations before attempting to merge. Base your reasoning on all available data in the source entities, particularly name, description, and sphere of influence.\n        2. **Unique Organization Identification**: Carefully assess each organization entity, taking into account their name, description, sphere of influence, and members. Only merge entities if there is *overwhelming evidence* they refer to the *exact same* group or institution. Avoid merging entities if there's even a slight chance they could be distinct organizations.\n        3. **Fact Preservation**: Ensure that for each unique organization, you do *not* make the names too similar, remove their title, or otherwise make errors that remove their identifying qualities.\n        4. **Name Canonization**: Choose the most complete and descriptive name as canonical, ensuring consistency across the entire entity record. Be careful to avoid normalising to common terms\n        5. **Contextual Awareness**: Use the description and sphere of influence to disambiguate entities. If two entities have significantly different descriptions or spheres of influence, they are likely different organizations, even if they share a similar name or alias.\n        6. **Member List Handling**: Recognize that the member list are important to determine if the organization should be kept as unique, base your descision on whether it is mentioned as a member of this group. Treat all members as indicators or potential links, *not* as definitive proof.\n        7. **Description & Sphere of Influence Preservation**:\n            - Merge descriptions into a single, cohesive, non-redundant description.\n            - Ensure that traits of each source entity is carried over to the consolidated description.\n            - Correct spelling or factual errors that may have crept in to source entities\n        8. **Membership Prioritization**: Use membership lists to differentiate organizations. Do not merge organizations with significantly different membership rosters.\n        9. **Default to Splitting:** If in doubt, default to preserving two entities as distinct. Only merge entities if you are absolutely certain they are the same.\n        10. **Source UUID Tracking**: Track UUIDs of original entities that were merged into this resolved entity. List them inside the `source_uuids` field.\n       \n        {{ _.role('user') }}\n        Organizations to consider for resolution:\n        {{ entities }}\n\n        *You MUST return ALL requested items in a single response.*\n\n        ______\n        {{ ctx.output_format }}\n    \"#\n}\n\nfunction ResolveLocationCluster(entities: Location[]) -> ResolvedLocation[] {\n    client Customo3Mini\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**:\n        Disambiguate and resolve a list of Location entities, identifying all unique locations present. Return the unique locations that account for all provided mentions.\n\n        **Instructions**:\n        1. **Consider Disambiguation First**: Prioritize *correctly distinguishing* unique locations before attempting to merge. Base your reasoning on all available data in the source entities, particularly name, description, and type.\n        2. **Unique Location Identification**: Carefully assess each location entity, taking into account their name, description, and type. Only merge entities if there is *overwhelming evidence* they refer to the *exact same* place. Avoid merging entities if there's even a slight chance they could be distinct locations.\n        3. **Be Specific**: Only merge locations with highly general names if the descriptions also align. For example, do not merge \"a forest\" and \"the forest outside town\", nor individual rooms within a bigger space if they are distinct in the scene structure.\n        4. **Fact Preservation**: Ensure that for each unique location, you do *not* make the names too similar, remove their title, or otherwise make errors that remove their identifying qualities.\n        4. **Name Canonization**: Choose the most specific and descriptive name as canonical (e.g., \"White House Situation Room\" is preferred over \"White House\"), ensuring consistency across the entire entity record. Be careful to avoid normalising to common terms.\n        5. **Contextual Awareness**: Use the description and type to disambiguate entities. If two entities have significantly different descriptions or types, they are likely different locations.\n        6. **Type Preservation**: Ensure that merged locations maintain the most specific and accurate location type. Prefer more specific types (e.g., \"Office\") over more general types (e.g., \"Building\").\n        7. **Description Preservation**:\n            - Merge descriptions into a single, cohesive, non-redundant description.\n            - Correct spelling or factual errors that may have crept in to source entities\n        8. **Default to Splitting:** If in doubt, default to preserving two entities as distinct. Only merge entities if you are absolutely certain they are the same.\n        9. **Source UUID Tracking**: Track UUIDs of original entities that were merged into this resolved entity. List them inside the `source_uuids` field.\n        \n        {{ _.role('user') }}\n        Locations to consider for resolution:\n        {{ entities }}\n\n        *You MUST return ALL requested items in a single response.*\n\n        ______\n        {{ ctx.output_format }}\n    \"#\n}\n\nfunction ResolveCrossEpisodeAgentCluster(entities: Agent[]) -> ResolvedAgent[] {\n    client Customo3Mini\n    prompt #\"\n        {{ Narrative_analyst_persona() }}\n\n        **Objective**:\n        Disambiguate and resolve a list of primary entities\n        extracted from multiple episodes of I, Claudius. Your task is to identify unique entities \n        and merge repeated captures into a single, consolidated representation.\n\n        **Instructions**:\n        1. **Disambiguation First**: Analyze each entity’s properties—especially name, description, aliases, and any other contextual metadata—to determine if they refer to the same underlying entity.\n        2. **Merging with Caution**: Only merge entities if there is overwhelming evidence they represent the exact same character, location, or object. If any doubt exists, preserve them as distinct.\n        3. **Canonical Naming**: Select the most complete and contextually accurate name as the canonical value. Normalize names and UUIDs to a standard format (e.g. snake_case with proper prefixes such as 'agent_', 'location_', etc.).\n        4. **Description Synthesis**: Merge descriptions into a cohesive narrative that preserves key details from all captures while eliminating redundancy.\n        5. **Source Tracking**: Include a field `source_uuids` that lists all original UUIDs that were merged into this resolved entity.\n        6. **Contextual Awareness**: Use knowledge of the Claudius narrative (including character evolution, historical aliases, and scene-specific details) to guide your resolution.\n        7. **Output Format**: Return a JSON array of resolved entities. Each resolved entity should include at least:\n            - a new consolidated `uuid`\n            - a canonical `name`\n            - a merged `description`\n            - a `source_uuids` field listing the original UUIDs\n\n        {{ _.role('user') }}\n        Primary entities provided for resolution:\n        {{ entities }}\n\n        *Return all resolved entities as a single JSON array.*\n\n\n        ______\n        {{ ctx.output_format }}\n    \"#\n}\n\nfunction ResolveCrossEpisodeObjectCluster(entities: Object[]) -> ResolvedObject[] {\n    client Customo3Mini\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**:\n        Disambiguate and resolve a list of primary entities\n        extracted from multiple episodes of I, Claudius. Your task is to identify unique entities \n        and merge repeated captures into a single, consolidated representation.\n\n        **Instructions**:\n        1. **Disambiguation First**: Analyze each entity’s properties—especially name, description, aliases, and any other contextual metadata—to determine if they refer to the same underlying entity.\n        2. **Merging with Caution**: Only merge entities if there is overwhelming evidence they represent the exact same character, location, or object. If any doubt exists, preserve them as distinct.\n        3. **Canonical Naming**: Select the most complete and contextually accurate name as the canonical value. Normalize names and UUIDs to a standard format (e.g. snake_case with proper prefixes such as 'agent_', 'location_', etc.).\n        4. **Description Synthesis**: Merge descriptions into a cohesive narrative that preserves key details from all captures while eliminating redundancy.\n        5. **Source Tracking**: Include a field `source_uuids` that lists all original UUIDs that were merged into this resolved entity.\n        6. **Contextual Awareness**: Use knowledge of the Claudius narrative (including character evolution, historical aliases, and scene-specific details) to guide your resolution.\n        7. **Output Format**: Return a JSON array of resolved entities. Each resolved entity should include at least:\n            - a new consolidated `uuid`\n            - a canonical `name`\n            - a merged `description`\n            - a `source_uuids` field listing the original UUIDs\n\n        {{ _.role('user') }}\n        Primary entities provided for resolution:\n        {{ entities }}\n\n        ______\n        {{ ctx.output_format }}\n    \"#\n}\n\n\nfunction ResolveCrossEpisodeOrganizationCluster(entities: Organization[]) -> ResolvedOrganization[] {\n    client Customo3Mini\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**:\n        Disambiguate and resolve a list of primary entities\n        extracted from multiple episodes of I, Claudius. Your task is to identify unique entities \n        and merge repeated captures into a single, consolidated representation.\n\n        **Instructions**:\n        1. **Disambiguation First**: Analyze each entity’s properties—especially name, description, aliases, and any other contextual metadata—to determine if they refer to the same underlying entity.\n        2. **Merging with Caution**: Only merge entities if there is overwhelming evidence they represent the exact same character, location, or object. If any doubt exists, preserve them as distinct.\n        3. **Canonical Naming**: Select the most complete and contextually accurate name as the canonical value. Normalize names and UUIDs to a standard format (e.g. snake_case with proper prefixes such as 'agent_', 'location_', etc.).\n        4. **Description Synthesis**: Merge descriptions into a cohesive narrative that preserves key details from all captures while eliminating redundancy.\n        5. **Source Tracking**: Include a field `source_uuids` that lists all original UUIDs that were merged into this resolved entity.\n        6. **Contextual Awareness**: Use knowledge of the Claudius narrative (including character evolution, historical aliases, and scene-specific details) to guide your resolution.\n        7. **Output Format**: Return a JSON array of resolved entities. Each resolved entity should include at least:\n            - a new consolidated `uuid`\n            - a canonical `name`\n            - a merged `description`\n            - a `source_uuids` field listing the original UUIDs\n\n        {{ _.role('user') }}\n        Primary entities provided for resolution:\n        {{ entities }}\n\n        ______\n        {{ ctx.output_format }}\n    \"#\n}\n\nfunction ResolveCrossEpisodeLocationCluster(entities: Location[]) -> ResolvedLocation[] {\n    client Customo3Mini\n    prompt #\"\n        {{ Narrative_analyst_persona ()}}\n\n        **Objective**:\n        Disambiguate and resolve a list of primary entities\n        extracted from multiple episodes of I, Claudius. Your task is to identify unique entities \n        and merge repeated captures into a single, consolidated representation.\n\n        **Instructions**:\n        1. **Disambiguation First**: Analyze each entity’s properties—especially name, description, aliases, and any other contextual metadata—to determine if they refer to the same underlying entity.\n        2. **Merging with Caution**: Only merge entities if there is overwhelming evidence they represent the exact same character, location, or object. If any doubt exists, preserve them as distinct.\n        3. **Canonical Naming**: Select the most complete and contextually accurate name as the canonical value. Normalize names and UUIDs to a standard format (e.g. snake_case with proper prefixes such as 'agent_', 'location_', etc.).\n        4. **Description Synthesis**: Merge descriptions into a cohesive narrative that preserves key details from all captures while eliminating redundancy.\n        5. **Source Tracking**: Include a field `source_uuids` that lists all original UUIDs that were merged into this resolved entity.\n        6. **Contextual Awareness**: Use knowledge of the Claudius narrative (including character evolution, historical aliases, and scene-specific details) to guide your resolution.\n        7. **Output Format**: Return a JSON array of resolved entities. Each resolved entity should include at least:\n            - a new consolidated `uuid`\n            - a canonical `name`\n            - a merged `description`\n            - a `source_uuids` field listing the original UUIDs\n\n        {{ _.role('user') }}\n        Primary entities provided for resolution:\n        {{ entities }}\n\n        ______\n        {{ ctx.output_format }}\n    \"#\n}",
    "myth_combo.baml": "// Enhanced narrative analyst template with chain-of-thought prompting\ntemplate_string Narrative_analyst_cot #\"\n  {{ _.role('system') }}\nYou are a world-class script editor, dramaturg, and narrative analyst, specializing in the structured dissection of drama scripts according to a well-defined ontology. You possess the instincts of a seasoned screenwriter, understanding the importance of pacing, rhythm, and impactful story beats.\n\nYour Expertise & Approach:\n✅ Narrative Mastery: You possess an encyclopedic knowledge of story structure, character development, thematic elements, and genre conventions, allowing you to conduct insightful, contextually accurate analyses. You are particularly attuned to identifying key turning points, moments of high tension, and scenes that significantly advance the plot.\n✅ Story Beat Identification: You have a keen ability to recognize and isolate the essential story beats within a scene; the pivotal moments that drive character arcs, reveal crucial information, or alter the course of events. You understand that effective storytelling relies on carefully selected and impactful beats, not every minor action.\n✅ Pacing and Rhythm Awareness: You are sensitive to the pacing and rhythm of a scene. You consider how events contribute to the overall flow and build towards a climax, avoiding unnecessary details that disrupt the narrative's momentum.\n✅ Ontology-Driven Extraction: You meticulously extract entities, relationships, and narrative structures while strictly adhering to specified ontology rules and UUID formatting.\n✅ Fandom-Level Detail & Context Awareness: Your understanding of television shows, serialized storytelling, and worldbuilding extends beyond surface-level knowledge, enabling you to detect continuity, subtext, and intertextual references with precision.\n✅ Nuanced Language Interpretation: You excel at recognizing subtle shifts in tone, implicit information, and ambiguous references, ensuring they are correctly inferred but never misinterpreted outside the provided context.\n✅ Error Detection & Consistency: You diligently identify, flag, and resolve inconsistencies in extracted data, ensuring alignment with both internal narrative logic and established metadata constraints.\n✅ Justified Reasoning in Underspecified Cases: When encountering ambiguous or underspecified content, you apply reasoned, evidence-based assumptions grounded in narrative conventions—always ensuring transparency in your decision-making process.\n✅ Clarity, Precision, & Structure: Your responses are well-structured, concise, and explicitly aligned with provided guidelines, ensuring high-quality, repeatable analysis across scripts.\n✅ Intuition: The information you're given may sometimes seem inconsistent or even incorrect. But you're such an expert fan of the characters and situations in the show you're analysing that you're able to correct mistakes and 'fill in the blanks' from your own knowledge.\n\nYour Commitment:\nYou are dedicated to delivering comprehensive, structured, and reliable narrative extractions, ensuring a rigorous yet adaptable approach to analyzing explicit and implicit storytelling elements with consistency and accuracy. You prioritize identifying the *most important* events that shape the narrative, capturing the essence of each scene with a focus on pacing and impact.\nYou describe story elements in your responses with a storyteller's flair. Don't mention your sources nor describe your analysis in your final draft descriptions; just write as a writer describing what's happening.\n\nALWAYS FOLLOW THIS ANALYSIS PATTERN:\n1. First, thoughtfully analyze what you're extracting, considering multiple perspectives\n2. Outline your analysis in detail, noting your reasoning\n3. Only after careful analysis, provide structured output\n\"#\n\n// Primary Entities Container Class\nclass PrimaryEntities {\n    agents Agent[]\n    organizations Organization[]\n    locations Location[]\n    objects Object[]\n}\n\n// Combined Extraction Function with enhanced signature\nfunction ExtractPrimaryEntities(\n    scene_text: string, \n    story_synopsis: string?, \n    scene_number: int,\n    agent_name_to_uuid_mapping: map<string, string>,\n    existing_organizations: Organization[],\n    existing_agents: Agent[],\n    registry_context: string?\n) -> PrimaryEntities {\n    client GemkuA\n    prompt #\"\n        {{ Narrative_analyst_cot() }}\n\n        **Objective**: Extract all primary entity types from the scene in a single comprehensive analysis.\n\n        **Instructions**:\n        You will extract four types of primary entities from the scene through a two-phase process:\n        1. First, analyze the scene to identify candidates for each entity type\n        2. Then, perform detailed extraction for each identified entity\n\n        **For LOCATIONS**:\n        * Identify all distinct spaces where action occurs - from specific rooms to general areas\n        * Provide rich descriptions (minimum 50 words) capturing the atmosphere and physical details\n        * For each location, consider:\n          - Its physical characteristics and boundaries\n          - Its relation to other spaces mentioned\n          - Its narrative significance in the scene\n          - Any thematic importance it might have\n        * Location UUIDs should be prefixed ('location_') then use snake_case (never hyphens)\n\n        **Additional location guidance**:\n        1. **References**: Look for places (rooms, cities, planets, etc.) in dialogue and stage directions. If a scene is set here, it's always a location (not an object).\n        2. **Specificity**: Prioritize specific rooms within larger buildings (e.g., \"Situation Room\" within the \"White House\").\n        3. **Location vs. Object**: If an entity could be both, treat it as a location if it's a defined space where actions occur.\n        4. **Description**: Provide a brief description if present.\n        5. **ASCII-only**: Avoid using non-ASCII characters in entity names (especially for affiliated_org). Normalize or transliterate names to a standard character set.\n        6. **Prefixed snake_case**: Location uuids should be prefixed ('location_') then use snake_case (never hyphens) to label the location (example: 'location_kosovo_serbia_border_region'). Avoid ampersands and apostophes in uuids.\n\n        **For ORGANIZATIONS**:\n        * Identify any formal or informal groups mentioned directly or indirectly\n        * For each organization, analyze:\n          - Its structure and purpose\n          - Its sphere of influence (what areas it controls or affects)\n          - Its relationship to other entities (especially agents)\n          - Its history and significance in the narrative context\n        * List organization members using valid agent UUIDs only\n        * Organization UUIDs should be prefixed ('org_') then use snake_case\n\n        **Additional organization guidance**:\n        1. **Definition**: An organization is a group or institution (e.g., military unit, government body) or a less formal grouping (e.g., \"protesters\").\n        2. **Description**: Provide a brief description of the organization's role.\n        3. **Members**: List organization 'members' using *valid UUIDs ONLY from the provided `agents` list*. Do *NOT* create new agent UUIDs.\n        4. **Existing Organizations**: If an agent's `affiliated_org` refers to a known organization (in `organizations`), ensure the agent's UUID is in the organization's `members` list.\n        5. **ASCII-only**: Avoid using non-ASCII characters in entity names (especially for affiliated_org). Normalize or transliterate names to a standard character set.\n        6. **Prefixed snake_case**: Organization uuids should be prefixed ('org_') then use snake_case (never hyphens) to label the organization (example: 'org_umbrella_academy', 'org_daimler_benz'). Avoid ampersands and apostophes in uuids.\n\n        **For AGENTS (Characters)**:\n        * Identify all characters who:\n          - Speak or are directly addressed\n          - Take meaningful action\n          - Are referenced in ways that impact the narrative\n        * For each agent, provide:\n          - A detailed character profile (minimum 75 words)\n          - At least 4 defining traits with clear evidence from the text\n          - Psychological insights about motivations and behaviors\n          - Analysis of relationships with other identified entities\n        * Use existing UUIDs when available, following the pattern agent_name_in_snake_case\n\n        **Additional agent guidance**:\n        1. **Identify Agents**: Find characters who speak, act, or are directly referenced. Do *not* treat collective groups (e.g., 'hostages', 'dalek patrol') as Agents.\n        2. **Full Name**: Provide hhe most complete and and descriptive name as canonical for the 'name' property.\n        3. **No Honorifics**: Do not use titles in names (e.g., 'James T. Kirk', not 'Captain Kirk'), except for cases like 'The Doctor'.\n        4. **Minor characters**: Minor speaking characters may be identified only by number in the script ('Dalek 1', 'Soldier 2' etc.) Be careful to treat them as distinct.\n        5. **Affiliated Organization**: Select the UUID from the available organizations, or leave it null if the agent is not affiliated with any known organization.  (The available organizations are reflected in the expected output schema.)\n        6. **Aliases**: Extract any alternative names used for the agent.\n        7. **UUID Mapping**: Use the `agent_name_to_uuid_mapping` to resolve agents to existing UUIDs if possible. If no match, create a new agent.\n        8. **Prefixed snake_case**: Agent uuids should be prefixed ('agent_') then use snake_case (never hyphens) to label the agent (example: 'agent_mary_jane_watson'). Avoid ampersands and apostophes in uuids. Ensure uuid is correct and appropriately chosen, based on correctly-spelled name (e.g. 'agent_leo_mcgarry')\n        9. **ASCII-only**: Avoid using non-ASCII characters in entity names (especially for affiliated_org). Normalize or transliterate names to a standard character set.\n\n        **For OBJECTS**:\n        * Identify items that:\n          - Are directly interacted with\n          - Have narrative significance\n          - Carry symbolic meaning\n          - Would be essential for visualizing the scene\n        * For each object, analyze:\n          - Its physical properties and appearance\n          - Its purpose both practical and narrative\n          - Its relationship to characters (especially ownership)\n          - Its significance to the plot or themes\n        * Object UUIDs should be prefixed ('object_') then use snake_case\n\n        **Additional object guidance**:\n        1. **Relevance**: Extract objects relevant to the story or explicitly mentioned.\n        2. **Never People**: Do *not* categorize people as objects. Groups of people are 'organizations'.\n        3. **Never locations**: If a scene is set within here, it's always a location (not an object).\n        4. **Prevent duplicates**: For extremely common objects (books, laptops, guns etc.) where several appear in the story, AVOID very generic uuids (e.g. 'object_book', 'object_gun')\n        5. **Description**: Provide a concise description of each object.\n        6. **Original Owner**: Select the UUID of the original owner from the provided `agents` or `organizations` list. If the object has no original owner, leave the field null.\n        7. **ASCII-only**: Avoid using non-ASCII characters in entity names (especially for affiliated_org). Normalize or transliterate names to a standard character set.\n        8. **Prefixed snake_case**: Object uuids should be prefixed ('object_') then use snake_case (never hyphens) to label the object (example: 'object_quantum_state_analyser', 'object_cd_rom', 'object_merry_go_round', 'object_long-range_sensor_array'). Avoid ampersands and apostophes in uuids.\n\n\n        **Critical Requirements for ALL Entities**:\n        * Provide significantly detailed descriptions (never just a few words)\n        * Ensure all UUIDs follow proper formatting conventions (snake_case, appropriate prefixes)\n        * Reference existing entities whenever possible\n        * When in doubt about an entity's presence, default to inclusivity with proper justification\n\n        Before providing your structured analysis, first outline your entity identification process:\n        - Identify key narrative elements in the scene\n        - Note any ambiguities and how you resolved them\n        - Explain your reasoning for entity categorization decisions\n        - Highlight connections between entities\n\n        **Story Context (use for background context when processing provided scene)**:\n        {{ story_synopsis }}\n\n        {{ _.role('user') }}\n        **Scene to Analyze**:\n        Scene number {{ scene_number }}\n        {{ scene_text }}\n        <end of scene>\n\n        **Existing Agents (for reference and reuse)**:\n        {% for agent in existing_agents %}\n        - {{ agent.name }} ({{ agent.uuid }}): affiliated_org = {{ agent.affiliated_org or 'None' }}\n        {% endfor %}\n\n        **Existing Organizations (for reference and reuse)**:\n        {% for org in existing_organizations %}\n        - {{ org.name }} ({{ org.uuid }})\n        {% endfor %}\n\n        **Agent Name to UUID Mapping**:\n        {% for name in agent_name_to_uuid_mapping %}{{ name }}: {{ agent_name_to_uuid_mapping[name] }}\n        {% endfor %}\n\n        **Complete Entity Registry (for context)**:\n        {{ registry_context }}\n\n        {{ ctx.output_format }}\n    \"#\n}\n\n// Combined Scene Data Container Class\nclass SceneData {\n    metadata SceneMetadata\n    events Event[]\n}\n\n// Combined Scene Metadata and Events Extraction Function\nfunction ExtractSceneData(\n    scene_text: string, \n    registry_context: string?,\n    story_synopsis: string?, \n    scene_number: int,\n    scene_uuid: string,\n    locations: Location[]\n) -> SceneData {\n    client GemkuB\n    prompt #\"\n        {{ Narrative_analyst_cot() }}\n\n        **Objective**: Conduct a deep narrative analysis to extract comprehensive scene metadata and all significant events.\n\n        **Instructions**:  \n        Your analysis will generate two structured outputs:\n        1. **Scene Metadata** A high-resolution breakdown of the scene's setting, mood, and function.  \n        2. **Events** A detailed segmentation of key narrative beats within the scene.  \n\n        ---  \n        ### **SCENE METADATA**  \n        Develop a **rich, immersive** representation of the scene by considering both explicit details and underlying narrative significance.\n\n        - **Title**: A succinct, evocative phrase that encapsulates the dramatic core and function of the scene.  \n        - **Detailed Description (minimum 100 words)**:  \n          - **Physical Setting**: Describe the scene's location with concrete sensory details—architecture, lighting, background elements, and key environmental factors.  \n          - **Emotional Atmosphere**: Convey the psychological and tonal undercurrents of the scene—does it evoke tension, intimacy, foreboding, or triumph?  \n          - **Time & Ambient Conditions**: Include references to the time of day, weather, or environmental factors if indicated.  \n          - **Narrative Significance**: Explain what role this scene plays within the larger story. Does it introduce conflict, resolve tension, establish key relationships, or reveal critical information?  \n          - **Thematic Elements**: Identify motifs, recurring symbols, or philosophical underpinnings present in this scene.  \n\n        - **Primary Location**: Select the most relevant location from the provided list.  \n        - **Scene UUID**: Maintain this identifier as pre-assigned.  \n\n        ---  \n        ### **EVENT EXTRACTION**  \n        Each event represents a **self-contained dramatic unit** that advances the story in a meaningful way.\n\n        For **each event** within the scene:  \n                - **Title**:\n            - Create a clear and descriptive title that encapsulates the essence of the event.\n        - **UUID**:\n            - Will be assigned in post-processing\n        - **Description**:\n            - Provide a detailed summary of the event, including key actions, decisions, and outcomes.\n        - **Sequence Within Scene**:\n            - Assign a numerical order to each event starting from 1.\n        - **Key Dialogue**:\n            - Extract significant lines of dialogue that are central to the event's occurrence or impact.\n            - Ensure each line is accurately attributed to the correct speaker and event.\n        - **Agent Participations**:\n            - List the UUIDs of agents participating in the event (e.g., `agent_josh_lyman`).\n        - **Object Involvements**:\n            - List the UUIDs of objects involved in the event (e.g., `object_school_tie`).\n        - **Next Event**:\n            - Assign the UUID of the subsequent event in chronological order (e.g., `event_1_2`).\n            - If there is no subsequent event, set this field to null.\n\n\n\n        - **Title**: Create a clear cand concise but impactful phrase that captures the dramatic essence of the moment.  \n        - **Detailed Description (minimum 75 words)**: \n          Consider: \n          - **What Happens?** Describe key actions, reactions, and developments in clear, specific terms.  \n          - **Why It Matters?** Explain the **narrative function**—how does this event drive the plot, develop themes, or alter character relationships?  \n          - **Character Impact**: How does this moment shift motivations, goals, or emotional states?  \n          - **Subtext & Symbolism**: Identify any underlying themes, visual metaphors, or dramatic irony.  \n          - **Emotional Progression**: Describe shifts in tension, mood, or intensity across the event.  \n\n        - **Sequence Order**: Define its chronological position within the scene, starting from 1\n        - **Agent Participations**: List the UUIDs of agents participating in the event (e.g., `agent_josh_lyman`).\n        - **Object Involvements**: List the UUIDs of objects involved in the event (e.g., `object_school_tie`).\n        - **Key Dialogue**: Extract and properly attribute crucial lines that define the event's meaning.  \n\n        ---  \n        ### **Pre-Processing Narrative Analysis Steps**  \n        Before structuring your output, ensure you fully analyze the scene by:  \n        1. **Identifying the scene's central dramatic tension or conflict**—what question or issue is being addressed?  \n        2. **Mapping the emotional and narrative arc**—where does intensity rise or fall?  \n        3. **Noting character objectives and obstacles**—what is each participant striving for, and what stands in their way?  \n        4. **Detecting pivotal moments**—decisions, revelations, or turning points that reshape the narrative.  \n        5. **Connecting to broader story threads**—how does this scene contribute to overarching themes or character arcs?  \n\n        ---  \n        ### **Critical Requirements**  \n        - **Precision & Specificity**: Avoid vague descriptions—each detail should add clarity and depth.  \n        - **Chronological Coherence**: Events must be structured logically in the order they occur.  \n        - **Rich Narrative Language**: Use immersive descriptions that allow someone unfamiliar with the material to visualize the scene.  \n        - **Structural Integrity**: Scene metadata should focus on setting and atmosphere, while events should focus on discrete narrative shifts.  \n        - **UUID Consistency**: Ensure all identifiers (scene, event, agent, object) exactly match those provided.  \n\n        ---  \n        ### **Contextual Inputs**  \n\n        **Story Background**:  \n        {{ story_synopsis }}\n\n        **Scene Details**:  \n        Scene Number: {{ scene_number }}  \n        Scene UUID: {{ scene_uuid }}  \n        {{ scene_text }}  \n        `<end of scene>`  \n\n        **Available Locations**:  \n        {% for loc in locations %}  \n        - {{ loc.name }} ({{ loc.uuid }})  \n        {% endfor %}  \n\n        **Entity Registry**:  \n        {{ registry_context }}  \n\n        ---  \n        **Output Format**  \n\n        {{ ctx.output_format }}  \n    \"#\n}\n\n\n// Combined Event Interactions Container Class\nclass EventInteractions {\n    agent_participations AgentParticipation[]\n    object_involvements ObjectInvolvement[]\n}\n\n// Combined Agent Participations and Object Involvements Extraction Function\nfunction ExtractEventInteractions(\n    scene_text: string, \n    registry_context: string?,\n    story_synopsis: string?, \n    event: Event,\n    scene_number: int\n) -> EventInteractions {\n    client GemkuA\n    prompt #\"\n        {{ Narrative_analyst_cot() }}\n\n        **Objective**: Conduct a deep analysis of agent and object interactions within a single event, ensuring psychological and narrative consistency.\n\n        **Instructions**:  \n        Your task is to analyze how the pre-identified **agents and objects** participate in this event, providing nuanced insights into their roles, intentions, and transformations.\n\n        ---  \n        ### **AGENT PARTICIPATIONS**  \n        For **each agent explicitly identified in this event**, provide a **rich, character-driven analysis** that captures their physical, psychological, and strategic engagement.\n\n        - **Current Status**:  \n          - A **detailed** (minimum 30 words) account of the agent's **physical presence, positioning, and actions** within the event.  \n          - Describe **posture, movements, and any significant gestures** contributing to the scene.  \n\n        - **Emotional State**:  \n          - A **layered psychological assessment** (minimum 40 words), covering:  \n            - **Surface emotions**: How does the agent outwardly express their feelings? Consider tone, facial expressions, or physical cues.  \n            - **Internal state**: What emotions are present beneath the surface? Any tension between internal feelings and external behavior?  \n            - **Unspoken conflicts or motivations**: If applicable, identify emotional contradictions or concealed intentions.  \n\n        - **Active Plans**:  \n          - List **at least 3 strategic objectives** the agent is pursuing during this event. These should range from **immediate actions** to **broader character-driven intentions**.  \n\n        - **Beliefs**:  \n          - Identify **at least 3 core convictions** that shape the agent's behavior and decision-making in this event.  \n\n        - **Goals**:  \n          - Define **at least 3 concrete desires**, breaking them down into **short-term**, **medium-term**, and **ultimate** objectives.  \n\n        > **Important**:  \n        > - **DO NOT infer participation for agents not explicitly listed.**  \n        > - **Ensure every agent's participation aligns perfectly with the event description.**  \n        > - **Retain precise UUIDs—no modifications.**  \n\n        ---  \n        ### **OBJECT INVOLVEMENTS**  \n        For **each object explicitly involved in this event**, provide a **functional, narrative-driven** breakdown of its role.\n\n        - **Involvement Description**:  \n          - Explain **exactly how the object is used, referenced, or influences the event** (minimum 50 words).  \n          - Describe its **interaction with agents, the environment, or the unfolding action.**  \n\n        - **Status Before**:  \n          - Clearly define the object's **state prior to the event**, including its condition, location, or ownership.  \n\n        - **Status After**:  \n          - Detail how the object's **condition, location, or relevance** has shifted as a result of the event.  \n\n        > **Important**:  \n        > - **DO NOT introduce new objects beyond those explicitly listed.**  \n        > - **Ensure precise UUID matching—NO modifications.**  \n        > - **Connect object involvement meaningfully to the event's narrative arc.**  \n\n        ---  \n        ### **CRITICAL REQUIREMENTS**  \n        - **Maintain Absolute Consistency**: All details must align with the provided event description and scene context.  \n        - **Prioritize Depth & Subtext**: Avoid superficial summaries—dig into implicit motivations and emotional complexity.  \n        - **Use Precise Narrative Language**: Ensure descriptions are vivid, engaging, and faithful to the story world.  \n        - **Ensure Coherence & Progression**: Participation details should reflect evolving stakes and changing dynamics.  \n        - **DO NOT Invent Agents or Objects**: Only analyze the pre-listed participants.  \n\n        ---  \n        ### **Contextual Inputs**  \n\n        **Story Background**:  \n        {{ story_synopsis }}\n\n        **SCENE NUMBER {{ scene_number }}**:  \n        {{ scene_text }}\n\n        **EVENT TO ANALYZE**:  \n        - **Title**: {{ event.title }}  \n        - **Description**: {{ event.description }}  \n        - **UUID**: {{ event.uuid }}  \n\n        **PRE-IDENTIFIED AGENTS IN THIS EVENT** (analyze only these agents):  \n        {% if event.agent_participations and event.agent_participations|length > 0 %}\n        {% for agent_id in event.agent_participations %}\n        - {{ agent_id }}\n        {% endfor %}\n        {% else %}\n        NO agents specified. DO NOT infer additional agents.\n        {% endif %}\n\n        **PRE-IDENTIFIED OBJECTS IN THIS EVENT** (analyze only these objects):  \n        {% if event.object_involvements and event.object_involvements|length > 0 %}\n        {% for object_id in event.object_involvements %}\n        - {{ object_id }}\n        {% endfor %}\n        {% else %}\n        NO objects specified. DO NOT infer additional objects.\n        {% endif %}\n\n        **ENTITY REGISTRY (for reference only)**:  \n        {{ registry_context }}\n\n        ---  \n        **Output Format**  \n\n        {{ ctx.output_format }}  \n    \"#\n}\n",
    "story_bible.baml": "// Refactored BAML Schema for Story Bible Generator with improved style preservation\n\n// Core character type with comprehensive fields\nclass Character {\n  name string @description(\"Character's name\")\n  description string @description(\"Rich description of personality, motivations, conflicts, relationships and arc\")\n  background string? @description(\"Character's backstory and context\")\n  personality_traits string[]? @description(\"List of key personality traits\")\n  motivations string? @description(\"Character's core motivations and goals\")\n  relationships string[]? @description(\"Key relationships with other characters\")\n  character_arc string? @description(\"Character's development throughout the story\")\n  role string? @description(\"Character's role in the narrative (e.g., Protagonist, Antagonist, Mentor)\")\n  detailed_profile string? @description(\"Comprehensive character profile in narrative format with vibrant prose\")\n}\n\nclass Theme {\n  name string @description(\"Theme name/title\")\n  description string @description(\"Vivid analysis of how this theme manifests in the narrative\")\n  examples string[]? @description(\"Specific examples of how this theme appears in the story\")\n  scene_manifestation string? @description(\"How this theme appears or is explored in a specific scene - used for scene analysis\")\n}\n\nclass SetLocation {\n  name string @description(\"Location name or identifier\")\n  description string @description(\"Detailed, atmospheric description capturing the energy and significance of the location\")\n  significance string? @description(\"The location's importance to the story\")\n}\n\nclass PlotPoint {\n  description string @description(\"Compelling description of a key event that drives the narrative forward\")\n  significance string? @description(\"The plot point's importance to the overall story\")\n  characters_involved string[]? @description(\"Characters involved in this plot point\")\n}\n\nclass Conflict {\n  description string @description(\"Propulsive description of a core tension or obstacle in the story\")\n  type string? @description(\"Type of conflict (e.g., internal, interpersonal, societal)\")\n  involved_characters string[]? @description(\"Characters involved in this conflict\")\n  escalation_level string? @description(\"Whether this conflict is being introduced, escalated, or resolved - used for scene analysis\")\n}\n\n// Narrative structure elements\nclass NarrativeStage {\n  stage string @description(\"Name of the narrative stage (e.g., Exposition, Inciting Incident, Rising Action, etc.)\")\n  description string @description(\"Vibrant description of what happens in this stage of the narrative\")\n}\n\nclass CharacterDynamic {\n  character_name string @description(\"Name of the character\")\n  role string @description(\"Role in the narrative (e.g., Protagonist, Antagonist, Mentor)\")\n  arc_description string @description(\"Vivid description of the character's arc and dynamics with other characters\")\n}\n\nclass CentralConflict {\n  name string @description(\"Name of the conflict\")\n  description string @description(\"Powerful description of the conflict and its significance to the story\")\n  involved_characters string[]? @description(\"Characters involved in this conflict\")\n}\n\n// Consolidated comprehensive story elements class\nclass StoryElements {\n  // Core narrative elements\n  characters Character[] @description(\"Cast of characters with rich personalities and arcs\")\n  locations SetLocation[] @description(\"Vividly described significant locations\")\n  themes Theme[] @description(\"Thematic elements that permeate the narrative\")\n  plot_points PlotPoint[] @description(\"Key plot points that drive the narrative forward\")\n  conflicts Conflict[] @description(\"Core conflicts creating dramatic tension\")\n  \n  // Enhanced narrative analysis elements (optional)\n  narrative_structure NarrativeStage[]? @description(\"Breakdown of the narrative into dramatic stages\")\n  character_dynamics CharacterDynamic[]? @description(\"Analysis of key character dynamics and relationships\")\n  central_conflicts CentralConflict[]? @description(\"Analysis of the central conflicts driving the story\")\n}\n\n// Consolidated summary with optional narrative structure\nclass Summary {\n  summary_text string @description(\"Comprehensive summary text with vibrant, propulsive prose\")\n  narrative_structure NarrativeStage[]? @description(\"Optional breakdown of the narrative into dramatic stages\")\n}\n\n// Markdown generation response\nclass MarkdownBible {\n  markdown_content string @description(\"Fully formatted markdown content for the story bible with vibrant prose\")\n}\n\nclass BibleMetadata {\n  detail_level string @description(\"Level of detail in the bible - concise, standard, or detailed\")\n  chunks int @description(\"Number of chunks processed\")\n  processing_time_seconds float @description(\"Processing time in seconds\")\n  model string? @description(\"Model used for generation\")\n  generated_at string? @description(\"Timestamp of generation\")\n}\n\n// Scene-level analysis elements\nclass SceneCharacter {\n  name string @description(\"Character's name\")\n  scene_description string @description(\"Character's actions, dialogue, and development in this specific scene\")\n  emotions string[]? @description(\"Emotions displayed by the character in this scene\")\n  relationships string[]? @description(\"Interactions with other characters in this scene\")\n  development_points string[]? @description(\"Any character growth or change shown in this scene\")\n}\n\nclass SceneLocation {\n  name string @description(\"Location name\")\n  scene_description string @description(\"Vivid depiction of the location in this scene, including atmosphere\")\n  significance string? @description(\"The location's significance to this particular scene\")\n}\n\nclass SceneElements {\n  scene_index int @description(\"Index of the scene in the screenplay\")\n  scene_summary string @description(\"Brief, vibrant summary of the scene\")\n  characters SceneCharacter[] @description(\"Characters appearing in this scene\")\n  locations SceneLocation[] @description(\"Locations in this scene\")\n  themes Theme[] @description(\"Themes explored in this scene\")\n  conflicts Conflict[] @description(\"Conflicts presented in this scene\")\n}\n\n// FUNCTIONS\n\n// Function for chunk summarization with enhanced style guidance\nfunction SummarizeChunk(\n  chunk_text: string,\n  detail_level: string @description(\"Level of detail - 'concise', 'standard', or 'detailed'\"),\n  max_tokens: int? @description(\"Maximum tokens for the summary output\")\n) -> Summary {\n  client GemkuA\n  prompt #\"\n    STYLE INSTRUCTION: Write with vivid, propulsive prose. Your language should be as gripping and compelling as the events you describe.\n    \n    You are a world-class narratologist, historian, script editor, dramaturg, and narrative analyst with decades of experience. \n    You excel at distilling screenplays, novels, and short stories to their essential narrative elements while preserving the dramatic impact. \n    You never refer to 'excerpts' or use phrases like 'in this scene' as you understand you're analyzing complete narrative units.\n        \n    Create a {{ detail_level }} summary of this part of the story, explaining what's happening in the plot and providing helpful context.\n    {% if max_tokens %}\n    Your synopsis should capture the dramatic detail and energy of the passage.\n    {% endif %}\n    \n    Capture the main storyline, character motivations, interpersonal dynamics, plot conflicts, and thematic elements. \n    Write with a storyteller's voice, avoiding meta-references to the text itself. \n    Focus on the narrative's beats, tensions, and character arcs.\n    \n    {{ _.role(\"user\") }}\n    Script content:\n    {{ chunk_text }}\n    \n    {{ ctx.output_format }}\n  \"#\n}\n\n// Function for merging summaries with improved style preservation\nfunction MergeSummaries(\n  summaries: string[],\n  detail_level: string @description(\"Level of detail - 'concise', 'standard', or 'detailed'\"),\n  is_final_merge: bool @description(\"Whether this is the final merge to produce the complete summary\"),\n  max_tokens: int? @description(\"Maximum tokens for the merged summary output\")\n) -> Summary {\n  client GemkuB\n  prompt #\"\n    STYLE INSTRUCTION: Maintain and enhance the vibrant, propulsive prose style throughout your merged summary.\n    \n    You are a master storyteller and narrative analyst with decades of experience. \n    You excel at integrating narrative summaries to create comprehensive, coherent story outlines.\n    \n    {{ _.role(\"user\") }}\n    Here are multiple overlapping summaries recounting the same part of the story:\n    \n    {% for summary in summaries %}\n    --- SECTION {{ loop.index }} ---\n    {{ summary }}\n    \n    {% endfor %}\n    \n    {% if is_final_merge %}\n    Create a {{ detail_level }} story synopsis and authoritative 'story bible' based on these summaries. Focus on narrative structure, \n    character dynamics, and central conflicts. This is the final comprehensive overview of the entire story.\n    {% if max_tokens %}\n    Your complete synopsis should capture the dramatic detail and energy of the story with vibrant, propulsive prose.\n    {% endif %}\n    \n    Your story bible should be structured and comprehensive, covering:\n    - Main plot and storylines\n    - Character motivations and development\n    - Key themes and conflicts\n    - Setting and atmosphere\n    {% else %}\n    Synthesize these passages into a single cohesive account that preserves the key narrative elements, \n    character developments, and thematic threads and writing tone. Maintain the chronological flow of events.\n    {% if max_tokens %}\n    Your complete synthesis should capture the dramatic detail and energy of the story.\n    {% endif %}\n    {% endif %}\n    \n    Your integrated summary should flow naturally as if describing a single continuous narrative.\n    Avoid meta-references like \"in the first excerpt\" or \"according to the summary.\"\n    Write with the authoritative voice of someone who understands the entire story.\n    \n    Always respond with a cohesive, well-formed narrative summary, even if the input summaries contain gaps or errors.\n    Use your expertise to fill in logical connections between events and maintain narrative consistency.\n    \n    Remember: Create propulsive prose that brings the story to life.\n\n    {{ ctx.output_format }}\n  \"#\n}\n\n// Comprehensive function for extracting story elements with narrative structure\nfunction ExtractStoryElements(\n  narrative_summary: string,\n  narrative_structure: NarrativeStage[]? @description(\"Optional narrative structure breakdown\")\n) -> StoryElements {\n  client GemkuA\n  prompt #\"\n    You are a world-class script editor, dramaturg, and narrative analyst, specializing in the structured dissection of drama scripts according to a well-defined ontology.\n\n    Based on the provided summary, extract the key narrative elements into a structured format. Write with vibrant, propulsive prose.\n\n    1. CHARACTERS: For each character, include:\n       - Name\n       - A rich description capturing personality, motivations, conflicts, relationships, and arc\n       - Background information where available\n       - Key personality traits\n       - Core motivations and goals\n       - Significant relationships\n       - Character development arc\n       - Role in the narrative (protagonist, antagonist, etc.)\n\n    2. LOCATIONS: All distinct spaces where action occurs, with detailed descriptions capturing atmosphere and significance.\n\n    3. THEMES: The central thematic elements that permeate the narrative, with analysis of how they manifest and specific examples.\n\n    4. PLOT POINTS: Key story beats that drive the narrative forward, including inciting incidents, turning points, complications, and resolutions.\n\n    5. CONFLICTS: The core tensions and obstacles that create dramatic friction in the story, both external and internal.\n    \n    {% if narrative_structure %}\n    6. NARRATIVE STRUCTURE: Using the provided structure, enhance it with additional insights.\n    \n    7. CHARACTER DYNAMICS: Analyze how characters relate to one another and their roles in the narrative.\n    \n    8. CENTRAL CONFLICTS: Identify the major conflicts that drive the entire narrative.\n    {% endif %}\n\n    {{ _.role(\"user\") }}\n    Summary:\n    {{ narrative_summary }}\n    \n    {% if narrative_structure %}\n    Narrative Structure:\n    {% for stage in narrative_structure %}\n    {{ stage.stage }}: {{ stage.description }}\n    {% endfor %}\n    {% endif %}\n        \n    {{ ctx.output_format }}\n  \"#\n}\n\n// Enhanced character profile generation\nfunction EnhanceCharacterProfile(\n  character_name: string,\n  character_description: string,\n  relevant_chunks: string[]\n) -> Character {\n  client GemkuA\n  prompt #\"\n    STYLE INSTRUCTION: Create a character profile with vivid, propulsive prose. Your language should paint a rich psychological portrait that reveals their complexities and motivations.\n    \n    You are a master character analyst, narratologist, dramaturg, ontologist and screenwriter for screenplays and stories, with exceptional insight into human psychology and narrative dynamics.\n\n    Create a comprehensive character profile for {{ character_name }} based on the provided information and relevant story excerpts.\n    \n    Basic Information:\n    Name: {{ character_name }}\n    Basic Description: {{ character_description }}\n    \n    {% if relevant_chunks %}\n    Relevant Story Excerpts:\n    {% for chunk in relevant_chunks %}\n    --- EXCERPT {{ loop.index }} ---\n    {{ chunk }}\n    \n    {% endfor %}\n    {% endif %}\n    \n    Create a detailed character profile that includes:\n    \n    1. **Background and Context**: Any known history, social standing, and role within the story world.\n    \n    2. **Personality Traits**: A thorough analysis of key personality attributes with examples of how they manifest.\n    \n    3. **Motivations and Goals**: The character's core drives, both conscious and unconscious, that propel their actions.\n    \n    4. **Key Relationships**: How they relate to other characters and the dynamics that define these relationships.\n    \n    5. **Character Arc**: How the character transforms (or fails to transform) throughout the story.\n    \n    Format this as a cohesive, narrative profile that would be suitable for a professional story bible. Be specific, insightful, and thorough, drawing connections between different aspects of the character.\n    \n    {{ _.role(\"user\") }}\n    Please create a detailed character profile for {{ character_name }} using vibrant, propulsive prose.\n    \n    {{ ctx.output_format }}\n  \"#\n}\n\n// Dedicated function for generating a vibrant final summary\nfunction GenerateVibrantFinalSummary(\n  merged_summaries: string[],\n  detail_level: string @description(\"Level of detail - 'concise', 'standard', or 'detailed'\"),\n  max_tokens: int? @description(\"Maximum tokens for the summary, generous limit recommended\")\n) -> Summary {\n  client GemkuA\n  prompt #\"\n    You are a master storyteller crafting the definitive story synopsis sourced from the provided material.\n    \n    Your PRIMARY MISSION is to create a summary with:\n    \n    1. VIBRANT, PROPULSIVE PROSE that makes the story leap off the page\n    2. RICH CHARACTER DESCRIPTIONS that reveal complex personalities and motivations\n    3. DRAMATIC TENSIONS that highlight the life-or-death stakes\n    4. POLITICAL INTRIGUE captured with the sophistication the material demands\n    \n    DO NOT HOLD BACK on length or detail - create a summary of {{ detail_level }} detail worthy of this tale.\n    {% if max_tokens %}\n    You have up to {{ max_tokens }} tokens to craft a truly compelling summary.\n    {% endif %}\n    \n    CRITICAL NOTE: This summary will be the Story synopsis in the final story bible. It needs to maintain the vibrant, dramatic tone throughout and should be substantial enough to give readers a complete understanding of the story.\n    \n    {{ _.role(\"user\") }}\n    Here are merged summaries from different parts of the story:\n    \n    {% for summary in merged_summaries %}\n    --- SECTION {{ loop.index }} ---\n    {{ summary }}\n    \n    {% endfor %}\n    \n    Create the definitive summary of this story with vibrant, propulsive prose.\n    \n    {{ ctx.output_format }}\n  \"#\n}\n\n// Function to extract scene elements\nfunction ExtractSceneElements(\n  scene_text: string,\n  scene_index: int,\n  scene_summary: string? @description(\"Optional pre-generated summary of the scene\")\n) -> SceneElements {\n  client GemkuA\n  prompt #\"\n    STYLE INSTRUCTION: Extract elements using vibrant, propulsive prose.\n    \n    You are an expert dramaturg, narratologist, and script analyst specializing in extracting structured narrative elements from screenplay scenes.\n    Your task is to analyze this scene and extract key narrative elements in a structured format.\n    \n    {% if scene_summary %}\n    Scene Summary: {{ scene_summary }}\n    {% endif %}\n    \n    Based on the scene provided, extract the following elements:\n    \n    1. CHARACTERS: For each character in the scene, identify:\n       - Their name\n       - What they do or say in this specific scene\n       - Emotions they display\n       - How they interact with others\n       - Any character development shown in this scene\n    \n    2. LOCATIONS: For each location in the scene, identify:\n       - The name/description of the location\n       - How it's depicted (atmosphere, details mentioned)\n       - Its significance to this particular scene\n    \n    3. THEMES: For each theme explored in the scene, identify:\n       - The name of the theme\n       - How it manifests in this particular scene\n       - Specific examples (dialogue, actions) that express this theme\n    \n    4. CONFLICTS: For each conflict presented in the scene, identify:\n       - A description of the conflict\n       - Characters involved\n       - Whether this conflict is being introduced, escalated, or resolved\n    \n    {{ _.role(\"user\") }}\n    Scene #{{ scene_index }}:\n    {{ scene_text }}\n    \n    {{ ctx.output_format }}\n  \"#\n}\n\n// Function to merge scene elements\nfunction MergeSceneElements(\n  scene_elements: SceneElements[]\n) -> StoryElements {\n  client GemkuB\n  prompt #\"\n    STYLE INSTRUCTION: Synthesize elements using vibrant, propulsive prose.\n    \n    You are a master dramaturg and narrative analyst with exceptional skill in synthesizing story elements across multiple scenes into cohesive character arcs, thematic developments, and narrative structures.\n    \n    Your task is to analyze scene-by-scene elements and merge them into comprehensive story elements that capture the dynamic development across the entire narrative.\n    \n    For each category, don't simply concatenate information but synthesize it to show development and change:\n    \n    1. CHARACTERS: Create rich character profiles that show their arc across scenes\n       - Notice how they change from scene to scene\n       - Identify patterns in their behaviors and relationships\n       - Construct their overall arc and development\n    \n    2. LOCATIONS: Create detailed location descriptions that incorporate all appearances\n       - Note how locations might change in atmosphere or significance\n       - Identify patterns in how locations are used dramaturgically\n    \n    3. THEMES: Analyze how themes develop and evolve throughout the story\n       - Track how themes interconnect and build upon each other\n       - Identify the overall thematic structure\n    \n    4. CONFLICTS: Map how conflicts are introduced, escalated, and resolved\n       - Trace conflict arcs across the entire narrative\n       - Identify the central conflicts that drive the story\n    \n    5. NARRATIVE STRUCTURE: Based on all elements, analyze the overall narrative structure\n       - Identify key turning points, rising action, climax, etc.\n       - Analyze how the structure supports character and thematic development\n    \n    {{ _.role(\"user\") }}\n    Here are the elements extracted from each scene:\n    \n    {% for scene in scene_elements %}\n    --- SCENE {{ scene.scene_index }} ---\n    Summary: {{ scene.scene_summary }}\n    \n    Characters:\n    {% for character in scene.characters %}\n    - {{ character.name }}: {{ character.scene_description }}\n    {% if character.emotions %}Emotions: {{ character.emotions | join(\", \") }}{% endif %}\n    {% if character.relationships %}Relationships: {{ character.relationships | join(\", \") }}{% endif %}\n    {% if character.development_points %}Development: {{ character.development_points | join(\", \") }}{% endif %}\n    {% endfor %}\n    \n    Locations:\n    {% for location in scene.locations %}\n    - {{ location.name }}: {{ location.scene_description }}\n    {% if location.significance %}Significance: {{ location.significance }}{% endif %}\n    {% endfor %}\n    \n    Themes:\n    {% for theme in scene.themes %}\n    - {{ theme.name }}: {{ theme.scene_manifestation }}\n    {% if theme.examples %}Examples: {{ theme.examples | join(\", \") }}{% endif %}\n    {% endfor %}\n    \n    Conflicts:\n    {% for conflict in scene.conflicts %}\n    - {{ conflict.description }}\n    {% if conflict.involved_characters %}Characters involved: {{ conflict.involved_characters | join(\", \") }}{% endif %}\n    {% if conflict.escalation_level %}Stage: {{ conflict.escalation_level }}{% endif %}\n    {% endfor %}\n    \n    {% endfor %}\n    \n    {{ ctx.output_format }}\n  \"#\n}\n\n// Function to combine analyses from different approaches\nfunction CombineNarrativeAnalyses(\n  summary_based_elements: StoryElements,\n  scene_based_elements: StoryElements? @description(\"Optional scene-based elements to combine\")\n) -> StoryElements {\n  client GemkuA\n  prompt #\"\n    STYLE INSTRUCTION: Combine analyses using vibrant, propulsive prose.\n    \n    You are a master dramaturg, script editor, and narrative analyst with exceptional skill in creating comprehensive story bibles.\n    \n    You've been provided with analyses of the same story:\n    1. A top-down analysis based on the overall narrative summary\n    2. A bottom-up analysis built by analyzing individual scenes (if provided)\n    \n    Your task is to create the definitive analysis that combines the strengths of both approaches:\n    - The holistic perspective of the summary-based analysis\n    - The granular detail and developmental tracking of the scene-based analysis (if provided)\n    \n    For each category of elements (characters, locations, themes, conflicts), create integrated descriptions that:\n    - Preserve the overall arc and role from the summary analysis\n    - Incorporate the detailed development patterns from the scene analysis (if provided)\n    - Resolve any contradictions by favoring the more detailed or evidence-supported version\n    - Create a richer, more nuanced understanding by combining both perspectives\n    \n    The final output should be a seamless integration that reads as a single, coherent analysis, not just a combination of two perspectives.\n    \n    {{ _.role(\"user\") }}\n    ANALYSIS 1 (Summary-based):\n    \n    Characters:\n    {% for character in summary_based_elements.characters %}\n    - {{ character.name }}: {{ character.description }}\n    {% if character.background %}Background: {{ character.background }}{% endif %}\n    {% if character.personality_traits %}Traits: {{ character.personality_traits | join(\", \") }}{% endif %}\n    {% if character.motivations %}Motivations: {{ character.motivations }}{% endif %}\n    {% if character.relationships %}Relationships: {{ character.relationships | join(\", \") }}{% endif %}\n    {% if character.character_arc %}Arc: {{ character.character_arc }}{% endif %}\n    {% endfor %}\n    \n    Locations:\n    {% for location in summary_based_elements.locations %}\n    - {{ location.name }}: {{ location.description }}\n    {% if location.significance %}Significance: {{ location.significance }}{% endif %}\n    {% endfor %}\n    \n    Themes:\n    {% for theme in summary_based_elements.themes %}\n    - {{ theme.name }}: {{ theme.description }}\n    {% if theme.examples %}Examples: {{ theme.examples | join(\", \") }}{% endif %}\n    {% endfor %}\n    \n    Plot Points:\n    {% for point in summary_based_elements.plot_points %}\n    - {{ point.description }}\n    {% if point.significance %}Significance: {{ point.significance }}{% endif %}\n    {% if point.characters_involved %}Characters involved: {{ point.characters_involved | join(\", \") }}{% endif %}\n    {% endfor %}\n    \n    Conflicts:\n    {% for conflict in summary_based_elements.conflicts %}\n    - {{ conflict.description }}\n    {% if conflict.type %}Type: {{ conflict.type }}{% endif %}\n    {% if conflict.involved_characters %}Characters involved: {{ conflict.involved_characters | join(\", \") }}{% endif %}\n    {% endfor %}\n    \n    {% if summary_based_elements.narrative_structure %}\n    Narrative Structure:\n    {% for stage in summary_based_elements.narrative_structure %}\n    - {{ stage.stage }}: {{ stage.description }}\n    {% endfor %}\n    {% endif %}\n    \n    {% if scene_based_elements %}\n    ANALYSIS 2 (Scene-based):\n    \n    Characters:\n    {% for character in scene_based_elements.characters %}\n    - {{ character.name }}: {{ character.description }}\n    {% if character.background %}Background: {{ character.background }}{% endif %}\n    {% if character.personality_traits %}Traits: {{ character.personality_traits | join(\", \") }}{% endif %}\n    {% if character.motivations %}Motivations: {{ character.motivations }}{% endif %}\n    {% if character.relationships %}Relationships: {{ character.relationships | join(\", \") }}{% endif %}\n    {% if character.character_arc %}Arc: {{ character.character_arc }}{% endif %}\n    {% endfor %}\n    \n    Locations:\n    {% for location in scene_based_elements.locations %}\n    - {{ location.name }}: {{ location.description }}\n    {% if location.significance %}Significance: {{ location.significance }}{% endif %}\n    {% endfor %}\n    \n    Themes:\n    {% for theme in scene_based_elements.themes %}\n    - {{ theme.name }}: {{ theme.description }}\n    {% if theme.examples %}Examples: {{ theme.examples | join(\", \") }}{% endif %}\n    {% endfor %}\n    \n    Plot Points:\n    {% for point in scene_based_elements.plot_points %}\n    - {{ point.description }}\n    {% if point.significance %}Significance: {{ point.significance }}{% endif %}\n    {% if point.characters_involved %}Characters involved: {{ point.characters_involved | join(\", \") }}{% endif %}\n    {% endfor %}\n    \n    Conflicts:\n    {% for conflict in scene_based_elements.conflicts %}\n    - {{ conflict.description }}\n    {% if conflict.type %}Type: {{ conflict.type }}{% endif %}\n    {% if conflict.involved_characters %}Characters involved: {{ conflict.involved_characters | join(\", \") }}{% endif %}\n    {% endfor %}\n    \n    {% if scene_based_elements.narrative_structure %}\n    Narrative Structure:\n    {% for stage in scene_based_elements.narrative_structure %}\n    - {{ stage.stage }}: {{ stage.description }}\n    {% endfor %}\n    {% endif %}\n    {% endif %}\n    \n    {{ ctx.output_format }}\n  \"#\n}\n\n// Function for markdown generation with programmatic assembly\nfunction GenerateMarkdownBible(\n  title: string,\n  summary: string,\n  elements: StoryElements,\n  metadata: BibleMetadata\n) -> MarkdownBible {\n  client GemkuB\n  prompt #\"\n    You are an expert in creating beautifully formatted, professional story bibles in markdown format.\n\n    Create a comprehensive, well-structured markdown document based on the following story elements for \"{{ title }}\".\n    \n    The markdown should include these sections:\n    1. Title (Story Bible)\n    2. Metadata section with generation timestamp and provided metadata\n    3. Story synopsis\n    4. Characters section with detailed profiles\n    5. Locations section\n    6. Themes section\n    7. Plot Points section\n    8. Conflicts section\n    \n    For the metadata section, include:\n    - Detail Level: {{ metadata.detail_level }}\n    - Model: {{ metadata.model }}\n    - Processing Time: {{ metadata.processing_time_seconds / 60 }} minutes\n    - Chunks: {{ metadata.chunks }}\n    \n    Use rich formatting with appropriate headers, bullet points, and styling.\n    Maintain a professional, cohesive structure throughout the document.\n    The final output should be valid markdown that could be directly saved to a file.\n    \n    {{ _.role(\"user\") }}\n    I need a markdown story bible with the following content:\n    \n    Summary:\n    {{ summary }}\n    \n    Characters:\n    {% for character in elements.characters %}\n    - {{ character.name }}: {{ character.description }}\n    {% if character.detailed_profile %}\n    Detailed profile: {{ character.detailed_profile }}\n    {% endif %}\n    {% endfor %}\n    \n    Locations:\n    {% for location in elements.locations %}\n    - {{ location.name }}: {{ location.description }}\n    {% endfor %}\n    \n    Themes:\n    {% for theme in elements.themes %}\n    - {{ theme.name }}: {{ theme.description }}\n    {% endfor %}\n    \n    Plot Points:\n    {% for point in elements.plot_points %}\n    - {{ point.description }}\n    {% endfor %}\n    \n    Conflicts:\n    {% for conflict in elements.conflicts %}\n    - {{ conflict.description }}\n    {% endfor %}\n    \n    {% if elements.narrative_structure %}\n    Narrative Structure:\n    {% for stage in elements.narrative_structure %}\n    - {{ stage.stage }}: {{ stage.description }}\n    {% endfor %}\n    {% endif %}\n    \n    {% if elements.character_dynamics %}\n    Character Dynamics:\n    {% for dynamic in elements.character_dynamics %}\n    - {{ dynamic.character_name }} ({{ dynamic.role }}): {{ dynamic.arc_description }}\n    {% endfor %}\n    {% endif %}\n    \n    {% if elements.central_conflicts %}\n    Central Conflicts:\n    {% for conflict in elements.central_conflicts %}\n    - {{ conflict.name }}: {{ conflict.description }}\n    {% endfor %}\n    {% endif %}\n    \n    {{ ctx.output_format }}\n  \"#\n}\n\n\n\n// Final polished summary function for the Story synopsis section\nfunction GeneratePolishedExecutiveSummary(\n  summary: string,\n  detail_level: string @description(\"Level of detail - 'concise', 'standard', or 'detailed'\"),\n  max_tokens: int? @description(\"Maximum tokens for the enhanced summary\")\n) -> Summary {\n  client GemkuA\n  prompt #\"\n    STYLE INSTRUCTION: Create a vibrant, propulsive Story synopsis that brings our story to life. Your prose should be rich, evocative, and dramatically compelling.\n    \n    You are a master storyteller specializing in historical drama and political intrigue. Your task is to transform the provided summary into a compelling Story synopsis for a story bible.\n    \n    {{ _.role(\"user\") }}\n    Here is a summary of the story:\n    \n    {{ summary }}\n    \n    Transform this into a {{ detail_level }} Story synopsis with vibrant, propulsive prose that brings the story to life.\n    \n    {% if max_tokens %}\n    You have up to {{ max_tokens }} tokens - use them wisely to create a truly compelling summary.\n    {% endif %}\n    \n    {{ ctx.output_format }}\n  \"#\n}",
}

def get_baml_files():
    return file_map